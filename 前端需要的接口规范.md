# 前端需要的WebSocket接口规范

## 🔌 WebSocket连接

### 连接地址
```
ws://localhost:8001
```

### 协议特点
- 每100ms推送一次完整快照
- 使用JSON格式（可优化为二进制）
- 自动重连

---

## 📊 数据推送格式（C++ → 前端）

### 完整快照消息

```json
{
  "type": "snapshot",
  "timestamp": 1702345678123,
  "data": {
    "orders": [
      {
        "id": 1001,
        "symbol": "BTC-USDT-SWAP",
        "side": "BUY",          // BUY|SELL
        "type": "LIMIT",        // LIMIT|MARKET
        "state": "FILLED",      // CREATED|SUBMITTED|FILLED|CANCELLED
        "price": 42500.0,
        "quantity": 0.1,
        "filled_quantity": 0.1,
        "timestamp": 1702345678000
      }
    ],
    "tickers": {
      "BTC-USDT-SWAP": {
        "last_price": 42500.0,
        "bid_price": 42499.0,
        "ask_price": 42501.0,
        "volume_24h": 1234567.89,
        "timestamp": 1702345678000
      },
      "ETH-USDT-SWAP": {
        ...
      }
    },
    "positions": [
      {
        "symbol": "BTC-USDT-SWAP",
        "side": "long",         // long|short
        "quantity": 0.5,
        "avg_price": 42000.0,
        "unrealized_pnl": 250.0,
        "notional_value": 21250.0
      }
    ],
    "accounts": [
      {
        "id": 1,
        "balance": 15000.0,
        "equity": 16250.0,
        "unrealized_pnl": 1250.0,
        "margin_ratio": 0.15
      }
    ],
    "strategies": [
      {
        "id": 1,
        "name": "网格策略A",
        "status": "running",    // running|stopped|error
        "pnl": 1250.50,
        "trades": 145
      }
    ]
  }
}
```

---

## 📤 命令发送格式（前端 → C++）

### 启动策略

```json
{
  "action": "start_strategy",
  "data": {
    "id": 1,
    "symbol": "BTC-USDT-SWAP",
    "config": {
      "param1": 100,
      "param2": 0.01
    }
  }
}
```

### 停止策略

```json
{
  "action": "stop_strategy",
  "data": {
    "id": 1
  }
}
```

### 手动下单

```json
{
  "action": "place_order",
  "data": {
    "account_id": 1,
    "symbol": "BTC-USDT-SWAP",
    "side": "BUY",
    "type": "LIMIT",
    "price": 42500.0,
    "quantity": 0.1
  }
}
```

### 取消订单

```json
{
  "action": "cancel_order",
  "data": {
    "order_id": 1001
  }
}
```

---

## 🔔 事件推送（增量更新）

除了100ms的完整快照，关键事件立即推送：

### 订单成交事件

```json
{
  "type": "event",
  "event_type": "order_filled",
  "timestamp": 1702345678123,
  "data": {
    "order_id": 1001,
    "symbol": "BTC-USDT-SWAP",
    "filled_price": 42500.0,
    "filled_quantity": 0.1
  }
}
```

### 持仓变化事件

```json
{
  "type": "event",
  "event_type": "position_updated",
  "timestamp": 1702345678123,
  "data": {
    "symbol": "BTC-USDT-SWAP",
    "quantity": 0.5,
    "unrealized_pnl": 250.0
  }
}
```

---

## 🎯 前端实现要点

### 1. WebSocket客户端

```javascript
// src/services/WebSocketClient.js

class WebSocketClient {
  constructor() {
    this.ws = null
    this.reconnectAttempts = 0
    this.listeners = new Map()
  }
  
  connect() {
    this.ws = new WebSocket('ws://localhost:8001')
    
    this.ws.onmessage = (event) => {
      const msg = JSON.parse(event.data)
      
      if (msg.type === 'snapshot') {
        // 完整快照（100ms一次）
        this.handleSnapshot(msg.data)
      } else if (msg.type === 'event') {
        // 增量事件（立即推送）
        this.handleEvent(msg.event_type, msg.data)
      }
    }
    
    this.ws.onerror = () => this.reconnect()
  }
  
  handleSnapshot(data) {
    // 批量更新Store
    orderStore.setOrders(data.orders)
    accountStore.setAccounts(data.accounts)
    positionStore.setPositions(data.positions)
    // 更新行情
    for (const [symbol, ticker] of Object.entries(data.tickers)) {
      marketStore.updateTicker(symbol, ticker)
    }
  }
  
  // 发送命令
  send(action, data) {
    this.ws.send(JSON.stringify({ action, data }))
  }
}
```

### 2. Store批量更新

```javascript
// src/stores/order.js

export const useOrderStore = defineStore('order', () => {
  const orders = ref([])
  
  // 批量设置（从快照）
  function setOrders(newOrders) {
    orders.value = newOrders
  }
  
  // 增量更新（从事件）
  function updateOrder(orderId, updates) {
    const order = orders.value.find(o => o.id === orderId)
    if (order) {
      Object.assign(order, updates)
    }
  }
  
  return { orders, setOrders, updateOrder }
})
```

---

## 📊 性能优化

### 节流策略

1. **完整快照** - 100ms一次
   - 包含所有状态
   - 用于全量刷新

2. **关键事件** - 立即推送
   - 订单成交
   - 策略状态变化
   - 仅推送变化部分

3. **行情数据** - 按需订阅
   - 前端指定需要的交易对
   - 只推送订阅的行情

### 前端优化

```javascript
// 使用requestAnimationFrame限制UI更新频率
let pendingUpdate = false

function updateUI(snapshot) {
  if (pendingUpdate) return
  
  pendingUpdate = true
  requestAnimationFrame(() => {
    // 更新DOM
    applySnapshot(snapshot)
    pendingUpdate = false
  })
}
```

---

## 🎯 总结

### C++端需要实现

1. ✅ 共享内存Journal读写
2. ✅ WebSocket服务器
3. ✅ 快照构建器（每100ms）
4. ✅ 命令处理器

### 前端需要实现

1. ✅ WebSocket客户端
2. ✅ 批量更新Store
3. ✅ 增量更新处理
4. ✅ 自动重连

### 性能目标

- **核心延迟**: <0.002ms（共享内存）
- **UI延迟**: 1-4ms（WebSocket）
- **前端刷新**: 100ms（不影响交易）

---

**接下来我为你创建完整的前端WebSocket客户端实现！** 🚀

