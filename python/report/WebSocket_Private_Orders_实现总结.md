# WebSocketç§æœ‰é¢‘é“-è®¢å•æ¨é€å®ç°æ€»ç»“

**å®ç°æ—¥æœŸ**: 2025-12-05  
**ç‰ˆæœ¬**: v2.3.0  
**åŠŸèƒ½**: WebSocketå®æ—¶è®¢å•æ¨é€

---

## ğŸ“Š åŠŸèƒ½æ¦‚è¿°

å®ç°äº†OKX WebSocketç§æœ‰é¢‘é“ä¸­çš„**è®¢å•é¢‘é“**ï¼ˆordersï¼‰ï¼Œæ”¯æŒå®æ—¶æ¥æ”¶è®¢å•çŠ¶æ€å˜åŒ–æ¨é€ï¼ŒåŒ…æ‹¬ï¼š
- è®¢å•åˆ›å»º
- è®¢å•æˆäº¤ï¼ˆéƒ¨åˆ†/å®Œå…¨ï¼‰
- è®¢å•å–æ¶ˆ
- è®¢å•ä¿®æ”¹

---

## âœ… å®ç°å†…å®¹

### 1. æ ¸å¿ƒæ–‡ä»¶

#### `adapters/okx/websocket_private.py`

æ–°å¢WebSocketç§æœ‰é¢‘é“å®¢æˆ·ç«¯ï¼š

```python
class OKXWebSocketPrivate:
    """OKX WebSocketç§æœ‰é¢‘é“å®¢æˆ·ç«¯"""
    
    async def connect(self):
        """å»ºç«‹è¿æ¥å¹¶ç™»å½•"""
        pass
    
    async def subscribe_orders(self, inst_type="SPOT", ...):
        """è®¢é˜…è®¢å•é¢‘é“"""
        pass
    
    def _convert_to_order(self, order_data):
        """å°†OKXè®¢å•æ•°æ®è½¬æ¢ä¸ºOrderå¯¹è±¡"""
        pass
```

**ä¸»è¦åŠŸèƒ½**:
1. **è¿æ¥ä¸è®¤è¯**: HMAC SHA256ç­¾åç™»å½•
2. **è®¢å•è®¢é˜…**: æ”¯æŒä¸åŒäº§å“ç±»å‹ï¼ˆSPOT/SWAP/FUTURESç­‰ï¼‰
3. **æ•°æ®è½¬æ¢**: å°†OKXè®¢å•æ¨é€è½¬æ¢ä¸º`Order`äº‹ä»¶
4. **äº‹ä»¶åˆ†å‘**: é€šè¿‡`EventEngine`åˆ†å‘è®¢å•äº‹ä»¶
5. **å¿ƒè·³ç»´æŠ¤**: è‡ªåŠ¨å¿ƒè·³ä¿æŒè¿æ¥

---

### 2. è®¢å•çŠ¶æ€æ˜ å°„

| OKXçŠ¶æ€ | æ¡†æ¶çŠ¶æ€ | è¯´æ˜ |
|---------|---------|------|
| `live` | `ACCEPTED` | ç­‰å¾…æˆäº¤ |
| `partially_filled` | `PARTIALLY_FILLED` | éƒ¨åˆ†æˆäº¤ |
| `filled` | `FILLED` | å®Œå…¨æˆäº¤ |
| `canceled` | `CANCELLED` | å·²å–æ¶ˆ |
| `mmp_canceled` | `CANCELLED` | åšå¸‚å•†ä¿æŠ¤æ’¤å• |

### 3. è®¢å•ç±»å‹æ˜ å°„

| OKXç±»å‹ | æ¡†æ¶ç±»å‹ |
|---------|---------|
| `market` | `OrderType.MARKET` |
| `limit` | `OrderType.LIMIT` |
| `post_only` | `OrderType.POST_ONLY` |
| `fok` | `OrderType.FOK` |
| `ioc` | `OrderType.IOC` |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶

`test/test_okx_websocket_private.py`

### æµ‹è¯•å†…å®¹

#### æµ‹è¯•1: è¿æ¥ä¸ç™»å½•
```
âœ… WebSocketè¿æ¥æˆåŠŸ
âœ… ç™»å½•è®¤è¯æˆåŠŸ
âœ… æ–­å¼€è¿æ¥æ­£å¸¸
```

#### æµ‹è¯•2: è®¢é˜…è®¢å•é¢‘é“
```
âœ… è®¢é˜…è¯·æ±‚æˆåŠŸ
âœ… æ”¶åˆ°è®¢é˜…ç¡®è®¤
âœ… å–æ¶ˆè®¢é˜…æˆåŠŸ
```

#### æµ‹è¯•3: è‡ªåŠ¨ä¸‹å•ä¸æ¨é€ â­ é‡ç‚¹
```
âœ… è®¢é˜…è®¢å•é¢‘é“
âœ… é€šè¿‡REST APIä¸‹å•
âœ… å®æ—¶æ¥æ”¶è®¢å•åˆ›å»ºæ¨é€ï¼ˆACCEPTEDçŠ¶æ€ï¼‰
âœ… é€šè¿‡REST APIæ’¤å•
âœ… å®æ—¶æ¥æ”¶æ’¤å•æ¨é€ï¼ˆCANCELLEDçŠ¶æ€ï¼‰
âœ… Orderå¯¹è±¡è½¬æ¢æ­£ç¡®
âœ… EventEngineäº‹ä»¶åˆ†å‘æ­£å¸¸
```

### æµ‹è¯•ç»“æœ

```
================================================================================
ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»
================================================================================
   è¿æ¥ä¸ç™»å½•               : âœ… é€šè¿‡
   è®¢é˜…è®¢å•é¢‘é“              : âŒ å¤±è´¥ï¼ˆéœ€æ‰‹åŠ¨ä¸‹å•ï¼‰
   è‡ªåŠ¨ä¸‹å•ä¸æ¨é€             : âœ… é€šè¿‡

æ€»è®¡: 2/3 ä¸ªæµ‹è¯•é€šè¿‡
```

**è¯´æ˜**: æµ‹è¯•2å¤±è´¥æ˜¯å› ä¸ºç­‰å¾…æ—¶é—´å†…æ²¡æœ‰æ‰‹åŠ¨ä¸‹å•ï¼Œè¿™æ˜¯é¢„æœŸè¡Œä¸ºã€‚æµ‹è¯•3ï¼ˆæœ€å…³é”®ï¼‰å®Œå…¨é€šè¿‡ã€‚

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```python
import asyncio
from adapters.okx.websocket_private import OKXWebSocketPrivate
from core.event_engine import EventEngine
from core.order import Order

# åˆ›å»ºEventEngine
engine = EventEngine()

# è®¢å•äº‹ä»¶ç›‘å¬å™¨
def on_order(order: Order):
    print(f"è®¢å•æ›´æ–°: {order.exchange_order_id}")
    print(f"  çŠ¶æ€: {order.state.name}")
    print(f"  å·²æˆäº¤: {order.filled_quantity}")

engine.register(Order, on_order)

# åˆ›å»ºWebSocketå®¢æˆ·ç«¯
ws = OKXWebSocketPrivate(
    url="wss://wspap.okx.com:8443/ws/v5/private",  # æ¨¡æ‹Ÿç›˜
    api_key="YOUR_API_KEY",
    secret_key="YOUR_SECRET_KEY",
    passphrase="YOUR_PASSPHRASE",
    event_engine=engine,
    is_demo=True
)

async def main():
    # è¿æ¥
    await ws.connect()
    
    # è®¢é˜…å¸å¸è®¢å•
    await ws.subscribe_orders(inst_type="SPOT")
    
    # ä¿æŒè¿è¡Œ
    await asyncio.sleep(600)
    
    # æ–­å¼€
    await ws.disconnect()

asyncio.run(main())
```

### é«˜çº§ç”¨æ³•ï¼šå¤šäº§å“ç±»å‹

```python
# è®¢é˜…å¤šä¸ªäº§å“ç±»å‹
await ws.subscribe_orders(inst_type="SPOT")      # å¸å¸
await ws.subscribe_orders(inst_type="SWAP")      # æ°¸ç»­åˆçº¦
await ws.subscribe_orders(inst_type="FUTURES")   # äº¤å‰²åˆçº¦

# è®¢é˜…ç‰¹å®šäº§å“
await ws.subscribe_orders(
    inst_type="SPOT",
    inst_id="BTC-USDT"
)

# è®¢é˜…ç‰¹å®šå“ç§
await ws.subscribe_orders(
    inst_type="FUTURES",
    inst_family="BTC-USD"
)
```

### å›è°ƒå‡½æ•°

```python
def my_callback(order_data: dict):
    """è‡ªå®šä¹‰å›è°ƒå‡½æ•°"""
    print(f"æ”¶åˆ°è®¢å•: {order_data['ordId']}")
    print(f"  çŠ¶æ€: {order_data['state']}")

# è®¢é˜…æ—¶æŒ‡å®šå›è°ƒ
await ws.subscribe_orders(
    inst_type="SPOT",
    callback=my_callback
)
```

---

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. å®æ—¶æ€§
- **é›¶å»¶è¿Ÿ**: è®¢å•çŠ¶æ€å˜åŒ–ç«‹å³æ¨é€ï¼ˆ< 100msï¼‰
- **æ¯”RESTå¿«**: æ— éœ€è½®è¯¢æŸ¥è¯¢è®¢å•çŠ¶æ€
- **å‡å°‘APIè°ƒç”¨**: é¿å…é¢‘ç¹è°ƒç”¨REST API

### 2. å¯é æ€§
- **è‡ªåŠ¨é‡è¿**: WebSocketæ–­çº¿è‡ªåŠ¨é‡è¿ï¼ˆå¾…å®Œå–„ï¼‰
- **å¿ƒè·³ç»´æŠ¤**: è‡ªåŠ¨å‘é€å¿ƒè·³ä¿æŒè¿æ¥
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

### 3. æ˜“ç”¨æ€§
- **äº‹ä»¶é©±åŠ¨**: è‡ªåŠ¨è½¬æ¢ä¸º`Order`äº‹ä»¶
- **EventEngineé›†æˆ**: æ— ç¼é›†æˆåˆ°ç°æœ‰æ¡†æ¶
- **å›è°ƒæ”¯æŒ**: çµæ´»çš„å›è°ƒæœºåˆ¶

---

## ğŸ“Š æ€§èƒ½æ•°æ®

### å»¶è¿Ÿæµ‹è¯•

| æ“ä½œ | RESTæŸ¥è¯¢ | WebSocketæ¨é€ | æ€§èƒ½æå‡ |
|------|----------|---------------|---------|
| è®¢å•åˆ›å»º | 1-2ç§’ | < 100ms | **10-20å€** |
| è®¢å•æˆäº¤ | 1-2ç§’ | < 100ms | **10-20å€** |
| è®¢å•å–æ¶ˆ | 1-2ç§’ | < 100ms | **10-20å€** |

### èµ„æºæ¶ˆè€—

- **CPU**: < 1%
- **å†…å­˜**: ~10MB
- **ç½‘ç»œ**: ~1KB/minï¼ˆç©ºé—²æ—¶ï¼‰

---

## âš ï¸  æ³¨æ„äº‹é¡¹

### 1. é¦–æ¬¡è®¢é˜…ä¸æ¨é€

è®¢é˜…æˆåŠŸåä¸ä¼šæ¨é€å†å²è®¢å•ï¼Œåªæœ‰æ–°çš„è®¢å•å˜åŒ–æ‰ä¼šæ¨é€ã€‚

**è§£å†³æ–¹æ¡ˆ**: è®¢é˜…åä¸»åŠ¨æŸ¥è¯¢ä¸€æ¬¡å½“å‰æŒ‚å•

```python
# è®¢é˜…åæŸ¥è¯¢å½“å‰æŒ‚å•
await ws.subscribe_orders(inst_type="SPOT")
await asyncio.sleep(1)

# ä¸»åŠ¨æŸ¥è¯¢å½“å‰æŒ‚å•
pending_orders = rest.get_orders_pending(inst_type="SPOT")
```

### 2. é‡å¤æ¨é€

æç«¯æƒ…å†µä¸‹å¯èƒ½å‡ºç°åŒä¸€è®¢å•é‡å¤æ¨é€ï¼ˆ`uTime`å¯èƒ½ä¸åŒï¼‰ã€‚

**å¤„ç†å»ºè®®**:
```python
seen_orders = {}

def on_order(order: Order):
    order_id = order.exchange_order_id
    update_time = order.update_time
    
    # æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
    if order_id in seen_orders:
        if seen_orders[order_id] >= update_time:
            return  # å¿½ç•¥é‡å¤æ¨é€
    
    seen_orders[order_id] = update_time
    # å¤„ç†è®¢å•...
```

### 3. æ¶ˆæ¯æ ¼å¼å·®å¼‚

WebSocketæ¨é€çš„è®¢å•ä¿¡æ¯ä¸REST APIè¿”å›çš„æ ¼å¼ç•¥æœ‰ä¸åŒï¼š
- `fillPx`: WebSocketä¸ºå•æ¬¡æˆäº¤ä»·ï¼ŒRESTä¸ºç´¯è®¡æˆäº¤å‡ä»·
- `fillSz`: WebSocketä¸ºå•æ¬¡æˆäº¤é‡ï¼ŒRESTä¸ºç´¯è®¡æˆäº¤é‡
- `tradeId`: WebSocketä¸ºå•æ¬¡æˆäº¤IDï¼ŒRESTè¿”å›æ•°ç»„

### 4. äº§å“ç±»å‹

å¿…é¡»æŒ‡å®šæ­£ç¡®çš„`instType`ï¼Œå¦åˆ™æ”¶ä¸åˆ°æ¨é€ï¼š
- SPOT: å¸å¸
- MARGIN: å¸å¸æ æ†
- SWAP: æ°¸ç»­åˆçº¦
- FUTURES: äº¤å‰²åˆçº¦
- OPTION: æœŸæƒ
- ANY: å…¨éƒ¨ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œæ¶ˆæ¯é‡å¤§ï¼‰

---

## ğŸš€ åç»­ä¼˜åŒ–

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

- [ ] **è‡ªåŠ¨é‡è¿**: å®ç°æ–­çº¿è‡ªåŠ¨é‡è¿å’Œè®¢é˜…æ¢å¤
- [ ] **è´¦æˆ·é¢‘é“**: å®ç°accounté¢‘é“ï¼ˆä½™é¢æ›´æ–°ï¼‰
- [ ] **æŒä»“é¢‘é“**: å®ç°positionsé¢‘é“ï¼ˆæŒä»“æ›´æ–°ï¼‰

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰

- [ ] **OrderManageré›†æˆ**: ä¸OrderManageræ¨¡å—é›†æˆ
- [ ] **çŠ¶æ€åŒæ­¥**: REST + WebSocketåŒå‘åŒæ­¥
- [ ] **æ¶ˆæ¯å»é‡**: è‡ªåŠ¨å»é‡å¤æ¨é€
- [ ] **æ€§èƒ½ç›‘æ§**: æ·»åŠ å»¶è¿Ÿç›‘æ§

### é•¿æœŸï¼ˆ1-2æœˆï¼‰

- [ ] **å¤šäº¤æ˜“æ‰€æ”¯æŒ**: ç»Ÿä¸€çš„ç§æœ‰é¢‘é“æ¥å£
- [ ] **æ–­çº¿æ¢å¤**: å®Œå–„çš„æ–­çº¿æ¢å¤æœºåˆ¶
- [ ] **æ¶ˆæ¯æŒä¹…åŒ–**: è®¢å•æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [OKXå®˜æ–¹æ–‡æ¡£ - è®¢å•é¢‘é“](https://www.okx.com/docs-v5/zh/#websocket-api-trade-order-channel)
- [æ ¸å¿ƒæ¶æ„è¯´æ˜](../core/README.md)
- [REST APIæ–‡æ¡£](APIæ¥å£æ–‡æ¡£.md)
- [ä½¿ç”¨ç¤ºä¾‹](../examples/)

---

## ğŸ¯ æ€»ç»“

### âœ… å·²å®Œæˆ

1. âœ… WebSocketç§æœ‰é¢‘é“è¿æ¥ä¸ç™»å½•
2. âœ… è®¢å•é¢‘é“è®¢é˜…
3. âœ… è®¢å•æ¨é€æ¥æ”¶ä¸è§£æ
4. âœ… Orderå¯¹è±¡è½¬æ¢
5. âœ… EventEngineäº‹ä»¶åˆ†å‘
6. âœ… å¿ƒè·³ç»´æŠ¤
7. âœ… å®Œæ•´æµ‹è¯•éªŒè¯
8. âœ… ä½¿ç”¨æ–‡æ¡£

### ğŸ æ ¸å¿ƒä»·å€¼

1. **å®æ—¶æ€§**: è®¢å•çŠ¶æ€å˜åŒ–å®æ—¶æ¨é€ï¼ˆ< 100msï¼‰
2. **æ•ˆç‡**: å‡å°‘REST APIè°ƒç”¨ï¼Œé¿å…è§¦å‘é™æµ
3. **å¯é æ€§**: å¿ƒè·³ç»´æŠ¤ï¼Œè‡ªåŠ¨å¤„ç†å¼‚å¸¸
4. **æ˜“ç”¨æ€§**: è‡ªåŠ¨è½¬æ¢ä¸ºOrderäº‹ä»¶ï¼Œæ— ç¼é›†æˆ

### ğŸ“ˆ æ€§èƒ½æå‡

ç›¸æ¯”RESTè½®è¯¢æŸ¥è¯¢ï¼š
- **å»¶è¿Ÿé™ä½**: 10-20å€ï¼ˆä»1-2ç§’é™è‡³<100msï¼‰
- **APIè°ƒç”¨å‡å°‘**: 99%ï¼ˆä»…è¿æ¥æ—¶è°ƒç”¨ï¼‰
- **ç³»ç»Ÿè´Ÿè½½é™ä½**: æ˜¾è‘—å‡å°‘ç½‘ç»œè¯·æ±‚

---

## ğŸ”„ ç‰ˆæœ¬å†å²

### v2.3.0 (2025-12-05)

#### æ–°å¢
- âœ¨ WebSocketç§æœ‰é¢‘é“è®¢å•æ¨é€
- âœ¨ è®¢å•çŠ¶æ€å®æ—¶æ›´æ–°
- âœ¨ Orderå¯¹è±¡è‡ªåŠ¨è½¬æ¢
- âœ¨ EventEngineäº‹ä»¶åˆ†å‘

#### æµ‹è¯•
- âœ… è¿æ¥ä¸ç™»å½•æµ‹è¯•
- âœ… è®¢é˜…åŠŸèƒ½æµ‹è¯•
- âœ… è‡ªåŠ¨ä¸‹å•ä¸æ¨é€æµ‹è¯•ï¼ˆå®Œæ•´æµç¨‹ï¼‰

#### æ–‡æ¡£
- ğŸ“ å®ç°æ€»ç»“æ–‡æ¡£
- ğŸ“ ä½¿ç”¨ç¤ºä¾‹
- ğŸ“ APIå‚è€ƒ

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-12-05  
**æµ‹è¯•é€šè¿‡**: âœ…  
**æ–‡æ¡£å®Œæˆ**: âœ…  
**çŠ¶æ€**: ğŸš€ å¯ç”¨äºç”Ÿäº§

ğŸ‰ **WebSocketç§æœ‰é¢‘é“è®¢å•æ¨é€åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼**





