# 📋 实盘框架待办清单

**更新时间**: 2025-12-05  
**当前版本**: v2.2.0

---

## 🚨 P0 - 必须完成（阻塞实盘）

### 1. 订单管理系统 ⏰ 3天
- [ ] 实现`OrderManager`类
  - [ ] 订单ID映射（本地 ↔ 交易所）
  - [ ] 订单状态跟踪
  - [ ] 活跃订单查询
  - [ ] 订单历史记录

- [ ] 集成到框架
  - [ ] 与`EventEngine`集成
  - [ ] 与`OKXRestAPI`集成
  - [ ] 订单事件分发

- [ ] 测试
  - [ ] 单元测试
  - [ ] 集成测试
  - [ ] 异常场景测试

**交付物**:
```
core/order_manager.py
test/test_order_manager.py
examples/order_manager_example.py
```

---

### 2. 账户/持仓管理 ⏰ 3天
- [ ] 实现`Account`类
  - [ ] 余额管理
  - [ ] 可用/冻结资金
  - [ ] 余额同步（REST）

- [ ] 实现`Position`类
  - [ ] 持仓数量
  - [ ] 成本价
  - [ ] 浮动盈亏
  - [ ] 已实现盈亏

- [ ] 实现`AccountManager`类
  - [ ] 账户信息管理
  - [ ] 持仓管理
  - [ ] 定期同步

**交付物**:
```
core/account.py
core/position.py
core/account_manager.py
test/test_account_manager.py
```

---

### 3. 基础风控模块 ⏰ 2天
- [ ] 实现`RiskManager`类
  - [ ] 订单风控检查
    - [ ] 单笔订单价值限制
    - [ ] 总持仓价值限制
    - [ ] 仓位比例限制
  - [ ] 余额检查
  - [ ] 标的黑名单

- [ ] 集成到下单流程
  - [ ] 下单前检查
  - [ ] 检查失败拒绝下单

**交付物**:
```
core/risk_manager.py
test/test_risk_manager.py
```

---

### 4. 异常处理完善 ⏰ 2天
- [ ] REST API
  - [ ] 请求重试（3次）
  - [ ] 超时处理
  - [ ] 错误码解析
  - [ ] 降级策略

- [ ] WebSocket
  - [ ] 自动重连
  - [ ] 订阅恢复
  - [ ] 心跳超时处理
  - [ ] 异常日志

**修改文件**:
```
adapters/okx/rest_api.py
adapters/okx/websocket.py
adapters/okx/adapter.py
```

---

## ⚡ P1 - 高优先级（1-2周）

### 5. WebSocket私有频道 ⏰ 4天
- [ ] 实现私有频道订阅
  - [ ] 订单更新频道
  - [ ] 账户更新频道
  - [ ] 持仓更新频道

- [ ] 事件处理
  - [ ] 订单事件→OrderManager
  - [ ] 账户事件→AccountManager
  - [ ] 持仓事件→AccountManager

- [ ] 认证与安全
  - [ ] WebSocket登录
  - [ ] 订阅鉴权

**交付物**:
```
adapters/okx/websocket_private.py
test/test_okx_websocket_private.py
examples/private_channel_example.py
```

---

### 6. 请求限流器 ⏰ 2天
- [ ] 实现`RateLimiter`类
  - [ ] 令牌桶算法
  - [ ] 滑动窗口算法
  - [ ] 按端点限流

- [ ] 集成到REST API
  - [ ] 自动限流
  - [ ] 超限等待
  - [ ] 限流告警

**交付物**:
```
core/rate_limiter.py
test/test_rate_limiter.py
```

---

### 7. 配置管理 ⏰ 2天
- [ ] 配置系统
  - [ ] 环境变量支持
  - [ ] 配置文件支持（YAML）
  - [ ] 配置验证
  - [ ] 默认配置

- [ ] 配置项
  - [ ] 交易所配置
  - [ ] 风控配置
  - [ ] 日志配置
  - [ ] 性能配置

**交付物**:
```
config.py
config.yaml.template
test/test_config.py
```

---

### 8. 日志系统改进 ⏰ 2天
- [ ] 结构化日志
  - [ ] 统一日志格式
  - [ ] JSON日志支持
  - [ ] 不同级别不同文件

- [ ] 日志轮转
  - [ ] 按时间轮转
  - [ ] 按大小轮转
  - [ ] 自动压缩

- [ ] 日志分类
  - [ ] 策略日志
  - [ ] 交易日志
  - [ ] 系统日志
  - [ ] 错误日志

**交付物**:
```
core/logger.py
test/test_logger.py
```

---

## 📊 P2 - 中优先级（2-4周）

### 9. 订单簿数据 ⏰ 3天
- [ ] 订单簿模型
  - [ ] `OrderBook`类
  - [ ] 增量更新
  - [ ] 快照维护

- [ ] WebSocket订阅
  - [ ] books频道
  - [ ] 深度选择（5/50/400档）

- [ ] 数据处理
  - [ ] 订单簿事件
  - [ ] 最优价格
  - [ ] 中间价

**交付物**:
```
core/orderbook.py
test/test_orderbook.py
examples/orderbook_example.py
```

---

### 10. 性能监控 ⏰ 2天
- [ ] 指标收集
  - [ ] 事件延迟
  - [ ] API延迟
  - [ ] WebSocket延迟
  - [ ] 订单成交时间

- [ ] 统计分析
  - [ ] 平均值
  - [ ] P99延迟
  - [ ] 吞吐量

- [ ] 告警
  - [ ] 高延迟告警
  - [ ] 异常告警

**交付物**:
```
core/performance_monitor.py
test/test_performance_monitor.py
```

---

### 11. 单元测试框架 ⏰ 3天
- [ ] 测试框架搭建
  - [ ] pytest配置
  - [ ] 测试fixture
  - [ ] Mock数据

- [ ] 单元测试
  - [ ] EventEngine测试
  - [ ] Order测试
  - [ ] Data模型测试
  - [ ] OrderManager测试
  - [ ] AccountManager测试
  - [ ] RiskManager测试

- [ ] 覆盖率
  - [ ] 代码覆盖率报告
  - [ ] 目标：>70%

**交付物**:
```
tests/unit/
tests/conftest.py
pytest.ini
.coveragerc
```

---

### 12. 数据存储 ⏰ 3天
- [ ] 数据库选型
  - [ ] 评估TimescaleDB/ClickHouse/SQLite
  - [ ] 架构设计

- [ ] 实现`DataStore`
  - [ ] K线存储
  - [ ] 交易记录存储
  - [ ] 订单历史存储
  - [ ] 查询接口

**交付物**:
```
core/datastore.py
test/test_datastore.py
migrations/
```

---

## 💡 P3 - 低优先级（可选）

### 13. Web管理界面
- [ ] 后端API（FastAPI）
- [ ] 前端界面（Vue.js）
- [ ] 功能
  - [ ] 策略启停
  - [ ] 实时监控
  - [ ] 持仓查看
  - [ ] 日志查看

### 14. 消息通知
- [ ] 邮件通知
- [ ] Telegram通知
- [ ] 企业微信通知

### 15. Binance适配器
- [ ] REST API
- [ ] WebSocket
- [ ] 与OKX接口统一

### 16. 回测引擎
- [ ] 历史数据回放
- [ ] 模拟撮合
- [ ] 绩效分析

---

## 🔧 技术债务

### 代码质量
- [ ] 添加类型检查（mypy）
- [ ] 代码格式化（black, isort）
- [ ] 代码检查（pylint, flake8）
- [ ] 文档生成（Sphinx）

### 性能优化
- [ ] 异步事件处理
- [ ] 连接池
- [ ] 响应缓存
- [ ] 数据结构优化

### 安全加固
- [ ] API密钥加密存储
- [ ] 敏感信息脱敏
- [ ] 审计日志

---

## 📅 开发计划

### Week 1-2: P0任务
```
□ 订单管理系统（3天）
□ 账户/持仓管理（3天）
□ 基础风控模块（2天）
□ 异常处理完善（2天）
```

### Week 3-4: P1任务
```
□ WebSocket私有频道（4天）
□ 请求限流器（2天）
□ 配置管理（2天）
□ 日志系统改进（2天）
```

### Week 5-8: P2任务
```
□ 订单簿数据（3天）
□ 性能监控（2天）
□ 单元测试框架（3天）
□ 数据存储（3天）
□ 文档完善（3天）
```

---

## 📊 进度跟踪

### 当前完成度

| 模块 | 完成度 | 状态 |
|------|--------|------|
| 核心架构 | 90% | ✅ 基本完成 |
| OKX REST API | 90% | ✅ 基本完成 |
| OKX WebSocket (公共) | 80% | ✅ 基本完成 |
| OKX WebSocket (私有) | 0% | ❌ 未开始 |
| 订单管理 | 0% | ❌ 未开始 |
| 账户管理 | 0% | ❌ 未开始 |
| 风险控制 | 0% | ❌ 未开始 |
| 配置管理 | 10% | ⚠️  基础硬编码 |
| 日志系统 | 30% | ⚠️  基础print |
| 监控系统 | 0% | ❌ 未开始 |
| 测试框架 | 20% | ⚠️  仅集成测试 |
| 文档 | 85% | ✅ 较完善 |

**总体完成度**: 约 **40%**

---

## 🎯 里程碑

### M1: 核心功能完成（Week 2）
- ✅ 订单管理
- ✅ 账户管理
- ✅ 基础风控
- ✅ 异常处理
- **状态**: 可以安全地进行小额实盘测试

### M2: 稳定性增强（Week 4）
- ✅ 私有频道
- ✅ 限流保护
- ✅ 配置管理
- ✅ 日志系统
- **状态**: 可以进行中等规模实盘

### M3: 功能完善（Week 8）
- ✅ 订单簿
- ✅ 性能监控
- ✅ 数据存储
- ✅ 单元测试
- **状态**: 生产级可用

---

## 📝 注意事项

### 开发规范
1. 所有新功能必须包含单元测试
2. 代码提交前必须通过类型检查
3. 重要变更需要更新文档
4. API接口需要保持向后兼容

### 测试要求
1. P0功能必须100%测试覆盖
2. P1功能建议80%以上覆盖
3. 所有异常路径必须测试
4. 集成测试在模拟盘运行

### 发布流程
1. 功能开发→本地测试
2. 代码审查→合并主分支
3. 模拟盘测试（24小时）
4. 小额实盘验证
5. 正式发布

---

## 🤝 协作

### 需要讨论的问题
- [ ] OrderManager接口设计确认
- [ ] 风控规则具体参数
- [ ] 数据库选型确认
- [ ] 监控指标定义
- [ ] 部署方式确认

### 资源需求
- **开发**: 2-3人全职
- **测试**: 1人兼职
- **运维**: 0.5人兼职
- **周期**: 2-3个月

---

**最后更新**: 2025-12-05  
**维护者**: Development Team  
**反馈渠道**: issues / 内部讨论群

🚀 **让我们一起把框架做得更好！**

