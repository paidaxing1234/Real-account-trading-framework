# 权限和角色说明

## 👥 用户角色

### 1. 超级管理员 (Super Admin)
**登录账号**: admin / admin123

**权限范围**: 所有权限
- ✅ 查看所有账号和策略
- ✅ 创建/修改/删除账号
- ✅ 启动/停止/删除策略
- ✅ 下单/撤单
- ✅ 用户管理
- ✅ 系统配置

**仪表板特点**:
- 显示所有账号的总资产
- 多账号净值对比图
- 多策略收益对比图
- 全局统计数据
- 完整的操作权限

### 2. 观摩者 (Viewer)
**登录账号**: viewer / viewer123

**权限范围**: 只读权限
- ✅ 查看账号净值
- ✅ 查看策略表现
- ✅ 查看订单和持仓
- ❌ 不能下单/撤单
- ❌ 不能启动/停止策略
- ❌ 不能修改账号
- ❌ 不能用户管理

**仪表板特点**:
- 选择单个账号查看
- 该账号的净值曲线
- 该账号的持仓分布
- 该账号的订单历史
- 所有数据只读

## 📊 不同角色看到的内容

### Dashboard页面

#### 超级管理员视图
```
┌─────────────────────────────────────┐
│  总资产 | 总盈亏 | 运行策略 | 活跃账户 │
├─────────────────────────────────────┤
│      多账号净值对比图（可选多个）      │
├─────────────────────────────────────┤
│     多策略收益对比图（可选多个）       │
├─────────────────────────────────────┤
│  最近订单  │  系统日志                │
└─────────────────────────────────────┘
```

#### 观摩者视图
```
┌─────────────────────────────────────┐
│  [观摩者模式提示]                     │
├─────────────────────────────────────┤
│  选择账号: [账号1] [账号2] [账号3]    │
├─────────────────────────────────────┤
│  账户净值 | 未实现盈亏 | 收益率        │
├─────────────────────────────────────┤
│      当前账号净值曲线                 │
├─────────────────────────────────────┤
│  当前持仓  │  最近订单（只读）         │
└─────────────────────────────────────┘
```

### 账户管理页面

#### 超级管理员
- ✅ 查看所有账户
- ✅ 添加账户按钮
- ✅ 编辑/删除/同步按钮
- ✅ 查看API Key

#### 观摩者
- ✅ 查看账户列表
- ❌ 无添加按钮
- ❌ 无编辑/删除按钮
- ❌ API Key被隐藏

### 策略管理页面

#### 超级管理员
- ✅ 启动/停止策略
- ✅ 创建/删除策略
- ✅ 修改策略参数
- ✅ 查看策略详情

#### 观摩者
- ✅ 查看策略列表
- ✅ 查看策略收益
- ❌ 无启动/停止按钮
- ❌ 无创建/删除按钮

### 订单管理页面

#### 超级管理员
- ✅ 查看所有订单
- ✅ 下单按钮
- ✅ 撤单按钮
- ✅ 批量操作

#### 观摩者
- ✅ 查看订单列表
- ❌ 无下单按钮
- ❌ 无撤单按钮
- ❌ 无操作按钮

## 🔒 权限实现

### 前端权限指令

**使用v-permission指令隐藏按钮**:
```vue
<template>
  <!-- 只有超级管理员能看到 -->
  <el-button v-permission="'order:create'">
    下单
  </el-button>
  
  <!-- 所有人都能看到 -->
  <el-button v-permission="'order:view'">
    查看
  </el-button>
</template>
```

### Permission组件

**包裹需要权限的内容**:
```vue
<Permission :permission="'strategy:start'">
  <el-button @click="startStrategy">启动策略</el-button>
</Permission>
```

## 📡 后端权限验证（C++）

### WebSocket消息验证

```cpp
// C++后端验证用户权限
void handleCommand(const json& message, const string& userId) {
    string action = message["action"];
    
    // 获取用户角色
    UserRole role = getUserRole(userId);
    
    if (action == "start_strategy") {
        // 检查权限
        if (role != UserRole::SUPER_ADMIN) {
            sendError("无权限执行此操作");
            return;
        }
        
        // 执行操作
        startStrategy(message["data"]);
    }
    else if (action == "place_order") {
        if (role != UserRole::SUPER_ADMIN) {
            sendError("观摩者无法下单");
            return;
        }
        
        placeOrder(message["data"]);
    }
}
```

### 数据过滤

```cpp
// 观摩者只能看到指定账号的数据
json generateSnapshot(const string& userId) {
    UserRole role = getUserRole(userId);
    json snapshot;
    
    if (role == UserRole::SUPER_ADMIN) {
        // 返回所有数据
        snapshot["accounts"] = getAllAccounts();
        snapshot["strategies"] = getAllStrategies();
    } 
    else if (role == UserRole::VIEWER) {
        // 只返回该用户有权限的账号数据
        auto allowedAccounts = getUserAllowedAccounts(userId);
        snapshot["accounts"] = filterAccounts(allowedAccounts);
        snapshot["strategies"] = filterStrategies(allowedAccounts);
    }
    
    return snapshot;
}
```

## 🎯 账号和策略权限分配

### 观摩者可以查看指定账号

**在用户表中配置**:
```json
{
  "userId": 2,
  "username": "viewer",
  "role": "viewer",
  "allowedAccounts": [1, 2],  // 可以查看账号1和账号2
  "allowedStrategies": [1, 3, 5]  // 可以查看策略1, 3, 5
}
```

**后端过滤数据**:
```cpp
vector<int> allowedAccounts = getUserAllowedAccounts(userId);
for (const auto& account : all_accounts) {
    if (find(allowedAccounts.begin(), allowedAccounts.end(), 
             account.id) != allowedAccounts.end()) {
        filtered_accounts.push_back(account);
    }
}
```

## 🖥️ 实现效果

### 超级管理员登录后
1. 看到"超级管理员视图 - 全局概览"
2. 所有账号净值对比（可选择多个）
3. 所有策略收益对比（可选择多个）
4. 所有操作按钮都可见
5. 可以访问用户管理页面

### 观摩者登录后
1. 看到"观摩者模式"提示
2. 选择单个账号查看
3. 该账号的净值曲线
4. 该账号的持仓和订单
5. 所有操作按钮隐藏
6. 无法访问用户管理页面

## 💻 测试账号

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | 超级管理员 | 所有权限 |
| viewer | viewer123 | 观摩者 | 只读权限 |

## 📝 使用示例

### 1. 超级管理员查看多账号对比
```javascript
// Dashboard会自动显示多账号对比图
// 可以勾选要对比的账号（最多5个）
✓ OKX账户1
✓ OKX账户2
✓ Binance账户1
```

### 2. 观摩者切换账号查看
```javascript
// 通过单选按钮切换账号
( ) OKX账户1
(•) OKX账户2  ← 当前查看
( ) Binance账户1
```

### 3. 权限检查
```javascript
import { useUserStore } from '@/stores/user'

const userStore = useUserStore()

// 检查单个权限
if (userStore.hasPermission('order:create')) {
  // 显示下单按钮
}

// 检查角色
if (userStore.isSuperAdmin) {
  // 显示管理功能
}
```

---

**现在重启前端，用不同账号登录查看效果！** 🎉

**登录后Dashboard会自动根据角色显示不同的界面！**

