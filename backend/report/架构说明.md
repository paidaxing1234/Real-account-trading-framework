# OKX实盘交易框架 - 架构说明

## 📊 项目结构

```
backend/
├── core/                        # ✅ 核心模块（已完成）
│   ├── __init__.py
│   ├── event_engine.py          # 事件引擎
│   ├── order.py                 # 订单模型
│   ├── data.py                  # 数据模型
│   └── README.md
│
├── adapters/                    # ⏳ 交易所适配器（待实现）
│   └── okx/
│       ├── __init__.py
│       ├── websocket.py         # WebSocket连接
│       ├── rest_api.py          # REST API封装
│       └── adapter.py           # OKX适配器组件
│
├── strategies/                  # ⏳ 策略模块（待实现）
│   ├── __init__.py
│   ├── base.py                  # 策略基类
│   └── demo_strategy.py         # 示例策略
│
├── utils/                       # ⏳ 工具模块（待实现）
│   ├── __init__.py
│   ├── account.py               # 账户管理
│   ├── risk.py                  # 风控模块
│   ├── recorder.py              # 数据记录
│   └── monitor.py               # 监控告警
│
├── engine.py                    # ⏳ 主引擎（待实现）
├── config.py                    # ⏳ 配置管理（待实现）
├── demo_core.py                 # ✅ 核心组件演示
├── okx_login_test.py            # ✅ OKX登录测试
├── requirements.txt             # ✅ 依赖包
└── 架构说明.md                   # 本文档
```

---

## ✅ 已完成部分

### 1. 核心模块（core/）

#### EventEngine - 事件引擎

**功能**：
- ✅ 事件注册与分发
- ✅ 时间戳管理
- ✅ 类型化监听
- ✅ 全局监听
- ✅ 防死循环机制（ignore_self）
- ✅ 动态接口注入

**测试**：通过 ✅
```bash
python -m core.event_engine
```

#### Order - 订单模型

**功能**：
- ✅ 订单数据结构
- ✅ 订单状态机（CREATED → SUBMITTED → ACCEPTED → FILLED）
- ✅ 订单类型（限价、市价、Post-only等）
- ✅ 买卖方向枚举
- ✅ 工厂方法（buy_limit, sell_market等）

**测试**：通过 ✅
```bash
python -m core.order
```

#### Data - 数据模型

**功能**：
- ✅ 行情数据（TickerData）
- ✅ 逐笔成交（TradeData）
- ✅ 订单簿（OrderBookData）
- ✅ K线数据（KlineData）
- ✅ 常用属性计算（中间价、价差等）

**测试**：通过 ✅
```bash
python -m core.data
```

#### 核心组件演示

**演示内容**：
- ✅ 事件引擎基本用法
- ✅ 组件生命周期管理
- ✅ 事件驱动通信
- ✅ 策略-订单管理-记录器协作

**运行**：
```bash
python demo_core.py
```

### 2. OKX登录测试

**功能**：
- ✅ WebSocket连接
- ✅ 签名算法实现
- ✅ 登录认证
- ✅ 错误处理

**测试**：通过 ✅（模拟盘）
```bash
python okx_login_test.py
```

---

## 🎯 核心设计原则

### 1. 事件驱动架构

所有组件通过事件通信，实现松耦合：

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   策略组件   │ ─Event→ │  事件引擎     │ ─Event→ │  订单管理器  │
│  Strategy   │         │ EventEngine  │         │OrderManager │
└─────────────┘         └──────────────┘         └─────────────┘
       ↑                        │                        │
       └────────────Event───────┴────────Event──────────┘
```

**优势**：
- 组件互不依赖，可独立开发测试
- 新增功能只需添加新组件
- 组件可以动态加载/卸载

### 2. 组件化设计

所有功能模块继承 `Component` 基类：

```python
class Component(ABC):
    @abstractmethod
    def start(self, engine: EventEngine):
        """启动时注册监听器"""
        pass
    
    @abstractmethod
    def stop(self):
        """停止时清理资源"""
        pass
```

**统一的生命周期管理**：
```
初始化 (__init__) → 启动 (start) → 运行 → 停止 (stop)
```

### 3. 数据流向

```
┌──────────────────────────────────────────────────────────┐
│                      实盘数据流                            │
└──────────────────────────────────────────────────────────┘

OKX交易所
    ↓ WebSocket推送
OKXWebSocketComponent
    ↓ 转换为TickerData/Order事件
EventEngine
    ↓ 分发给所有监听器
    ├→ Strategy.on_ticker()          # 策略收到行情
    ├→ Account.on_ticker()           # 账户更新价格
    └→ Recorder.on_ticker()          # 记录器记录数据

Strategy判断后发出订单
    ↓ Order事件
EventEngine
    ↓ 分发
    ├→ Account.on_order()            # 账户更新订单状态
    ├→ OKXAdapter.on_order()         # 适配器发送到交易所
    └→ Recorder.on_order()           # 记录器记录订单

OKX交易所返回订单更新
    ↓ WebSocket推送
OKXWebSocketComponent
    ↓ 转换为Order事件（状态=FILLED）
EventEngine
    ↓ 分发
    ├→ Strategy.on_order()           # 策略知道成交了
    ├→ Account.on_order()            # 账户更新持仓
    └→ Recorder.on_order()           # 记录成交
```

---

## 🔄 与HftBacktest的差异

| 特性 | HftBacktest（回测） | 本框架（实盘） |
|------|-------------------|---------------|
| **数据来源** | 历史Parquet文件 | OKX WebSocket实时推送 |
| **时间推进** | 手动遍历历史数据 | 系统实时时间 |
| **引擎数量** | 双引擎（Server/Client） | 单引擎 |
| **延迟模拟** | DelayBus模拟网络延迟 | 真实网络延迟 |
| **订单执行** | 本地撮合引擎 | OKX真实撮合 |
| **运行模式** | `while data:` 遍历完结束 | `while True:` 常驻进程 |
| **组件设计** | ✅ 复用 | ✅ 复用 |
| **事件引擎** | ✅ 复用 | ✅ 复用（已实现） |
| **订单模型** | ✅ 参考 | ✅ 增强（已实现） |

---

## 📝 下一步开发计划

### Phase 1: OKX适配器 ⏳

**目标**：连接OKX交易所，实现双向通信

**任务**：
1. **OKXWebSocket** - WebSocket连接组件
   - 登录认证
   - 订阅频道（行情、订单、账户）
   - 心跳保持
   - 自动重连
   - 消息解析

2. **OKXRestAPI** - REST API封装
   - 下单（limit, market）
   - 撤单
   - 查询订单
   - 查询账户余额
   - 查询持仓

3. **OKXAdapter** - 统一适配器组件
   - 监听内部Order事件 → 调用REST API下单
   - 接收WebSocket推送 → 转换为内部Event
   - 错误处理和重试逻辑

**预计时间**：2-3天

---

### Phase 2: 账户管理 ⏳

**目标**：维护账户状态

**任务**：
1. **AccountManager**
   - 订单字典（活跃订单）
   - 持仓字典（各币种持仓）
   - 余额管理（可用/冻结）
   - 接口注入（engine.get_positions()）

2. **RiskControl**
   - 最大持仓限制
   - 最大下单量限制
   - 单日亏损限制
   - 订单频率限制

**预计时间**：1-2天

---

### Phase 3: 策略框架 ⏳

**目标**：提供策略开发的基础设施

**任务**：
1. **StrategyBase** - 策略基类
   - on_ticker() 行情回调
   - on_order() 订单回调
   - send_order() 发单接口
   - 持仓查询接口

2. **DemoStrategy** - 示例策略
   - 简单做市策略
   - 展示完整流程

**预计时间**：1天

---

### Phase 4: 工具模块 ⏳

**目标**：提供记录、监控等辅助功能

**任务**：
1. **Recorder** - 数据记录器
   - 记录所有成交
   - 定期快照（PnL、持仓）
   - CSV/数据库存储

2. **Monitor** - 监控告警
   - 健康检查
   - 异常告警（钉钉/邮件）
   - 性能统计

**预计时间**：1-2天

---

### Phase 5: 主引擎和配置 ⏳

**目标**：整合所有组件，提供统一入口

**任务**：
1. **RealTradingEngine** - 主引擎
   - 组件管理
   - 生命周期控制
   - 优雅退出

2. **Config** - 配置管理
   - 交易所凭证
   - 策略参数
   - 风控参数

**预计时间**：1天

---

## 🧪 测试计划

### 单元测试
- [x] EventEngine 测试
- [x] Order模型 测试
- [x] Data模型 测试
- [ ] OKXAdapter 测试
- [ ] AccountManager 测试
- [ ] Strategy 测试

### 集成测试
- [x] 核心组件协作演示
- [ ] OKX模拟盘端到端测试
- [ ] 策略回测验证
- [ ] 异常场景测试

### 压力测试
- [ ] 高频行情处理
- [ ] 并发订单处理
- [ ] 长时间运行稳定性

---

## 🎓 学习资源

### 1. 事件驱动模式
- 观察者模式
- 发布-订阅模式
- 消息队列

### 2. OKX API文档
- [OKX API官方文档](https://www.okx.com/docs-v5/zh/)
- WebSocket API
- REST API

### 3. Python异步编程
- asyncio库
- websockets库
- aiohttp库

---

## 💡 关键概念

### EventEngine（事件引擎）
> 框架的"心脏"，负责事件的接收、存储和分发

### Component（组件）
> 所有功能模块的基类，统一生命周期管理

### Event（事件）
> 数据载体，订单、行情、账户更新都是事件

### 适配器（Adapter）
> "翻译官"，连接内部事件系统和外部交易所API

### 策略（Strategy）
> 交易逻辑的实现，监听行情，发出订单

---

## 📞 支持

如有问题，请参考：
1. `core/README.md` - 核心模块文档
2. `demo_core.py` - 使用示例
3. HftBacktest源码 - 参考实现

---

**版本**：v0.1.0  
**更新时间**：2025-12-04  
**状态**：核心模块已完成 ✅，开始实现OKX适配器 ⏳

