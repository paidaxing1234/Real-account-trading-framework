# Kungfuï¼ˆåŠŸå¤«ï¼‰é‡åŒ–äº¤æ˜“æ¡†æ¶æ·±åº¦åˆ†æ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**Kungfuï¼ˆåŠŸå¤«ï¼‰** æ˜¯ä¸€ä¸ªä¸“ä¸ºé‡åŒ–äº¤æ˜“è€…è®¾è®¡çš„å¼€æºäº¤æ˜“æ‰§è¡Œç³»ç»Ÿï¼Œç”± [taurus.ai](https://libkungfu.cc) å¼€å‘ç»´æŠ¤ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- âœ… **å¾®ç§’çº§ä½å»¶è¿Ÿ**ï¼šç³»ç»Ÿå†…å“åº”æ—¶é—´è¾¾åˆ°å¾®ç§’çº§
- âœ… **çº³ç§’çº§æ—¶é—´æˆ³**ï¼šæ”¯æŒçº³ç§’çº§ç²¾åº¦çš„æ•°æ®è®°å½•å’Œåˆ†æ
- âœ… **è·¨å¹³å°**ï¼šæ”¯æŒ Windowsã€macOSã€Linux
- âœ… **å¤šè¯­è¨€**ï¼šæ”¯æŒ C++/Python ç­–ç•¥å¼€å‘
- âœ… **å‹å¥½UI**ï¼šæä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œç®€åŒ–è¿ç»´æµç¨‹

**å¼€æºåè®®**ï¼šApache License 2.0

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### ä¸‰å¤§æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kungfu äº¤æ˜“ç³»ç»Ÿæ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Longfistï¼ˆé•¿æ‹³ï¼‰- æ•°æ®æ ¼å¼å®šä¹‰                        â”‚  â”‚
â”‚  â”‚     â”œâ”€ ç»Ÿä¸€çš„é‡‘èæ•°æ®ç»“æ„                                 â”‚  â”‚
â”‚  â”‚     â”œâ”€ è·¨è¯­è¨€åºåˆ—åŒ– (C++/Python/JS/SQLite)                â”‚  â”‚
â”‚  â”‚     â””â”€ ç±»å‹å®‰å…¨çš„æ•°æ®æ¨¡å‹                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. Yijinjingï¼ˆæ˜“ç­‹ç»ï¼‰- æ—¶é—´åºåˆ—å†…å­˜æ•°æ®åº“                â”‚  â”‚
â”‚  â”‚     â”œâ”€ è¶…ä½å»¶è¿Ÿå†…å­˜æ˜ å°„                                   â”‚  â”‚
â”‚  â”‚     â”œâ”€ çº³ç§’çº§æ—¶é—´ç²¾åº¦                                     â”‚  â”‚
â”‚  â”‚     â”œâ”€ é›¶æ‹·è´æ•°æ®è®¿é—®                                     â”‚  â”‚
â”‚  â”‚     â””â”€ å…¨éƒ¨æ•°æ®å¯è½åœ°                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. Wingchunï¼ˆå’æ˜¥ï¼‰- ç­–ç•¥æ‰§è¡Œå¼•æ“                         â”‚  â”‚
â”‚  â”‚     â”œâ”€ ç­–ç•¥è¿è¡Œæ—¶ç¯å¢ƒ                                     â”‚  â”‚
â”‚  â”‚     â”œâ”€ è´¦ç›®/æŒä»“ç®¡ç†                                      â”‚  â”‚
â”‚  â”‚     â”œâ”€ RxCpp å“åº”å¼ç¼–ç¨‹                                   â”‚  â”‚
â”‚  â”‚     â””â”€ ç­–ç•¥æ¥å£ (C++/Python)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å‰ç«¯ UI (Electron + Vue.js)                             â”‚  â”‚
â”‚  â”‚  åå° API (Node.js)                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä½å»¶è¿Ÿå®ç°åŸç†

### 1. **Yijinjingï¼ˆæ˜“ç­‹ç»ï¼‰- æ ¸å¿ƒä½å»¶è¿Ÿå¼•æ“**

Yijinjing æ˜¯ Kungfu å®ç°ä½å»¶è¿Ÿçš„æ ¸å¿ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸“ä¸ºé‡‘èäº¤æ˜“è®¾è®¡çš„æ—¶é—´åºåˆ—å†…å­˜æ•°æ®åº“ã€‚

#### 1.1 å†…å­˜æ˜ å°„ï¼ˆmmapï¼‰æŠ€æœ¯

**æ ¸å¿ƒä»£ç **ï¼š`yijinjing/journal/page.cpp`

```cpp
page_ptr page::load(const data::location_ptr &location, uint32_t dest_id, 
                    uint32_t page_id, bool is_writing, bool lazy) {
    uint32_t page_size = find_page_size(location, dest_id);
    std::string path = get_page_path(location, dest_id, page_id);
    
    // å…³é”®ï¼šä½¿ç”¨ mmap åŠ è½½é¡µé¢åˆ°å†…å­˜
    uintptr_t address = os::load_mmap_buffer(path, page_size, is_writing, lazy);
    
    if (address == 0) {
        throw journal_error("unable to load page for " + path);
    }
    
    // ç›´æ¥æ“ä½œå†…å­˜åœ°å€ï¼Œé›¶æ‹·è´
    page_header *header = reinterpret_cast<page_header *>(address);
    
    return std::shared_ptr<page>(new page(location, dest_id, page_id, 
                                         page_size, lazy, address));
}
```

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… **é›¶æ‹·è´**ï¼šæ•°æ®ç›´æ¥åœ¨å†…å­˜ä¸­è®¿é—®ï¼Œæ— éœ€åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… **å†…æ ¸çº§ä¼˜åŒ–**ï¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é¡µç¼“å­˜æœºåˆ¶
- âœ… **æŒä¹…åŒ–**ï¼šå†…å­˜æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ°ç£ç›˜

#### 1.2 é¡µé¢ï¼ˆPageï¼‰è®¾è®¡

**é¡µé¢å¤§å°**ï¼šæ ¹æ®æ•°æ®ç±»å‹åŠ¨æ€è°ƒæ•´

```cpp
inline static uint32_t find_page_size(const data::location_ptr &location, 
                                      uint32_t dest_id) {
    // è¡Œæƒ…æ•°æ®ï¼š128MB å¤§é¡µé¢ï¼ˆæ•°æ®é‡å¤§ï¼‰
    if (location->category == longfist::enums::category::MD && dest_id != 1) {
        return 128 * MB;
    }
    
    // äº¤æ˜“æ•°æ®/ç­–ç•¥æ•°æ®ï¼š16MB ä¸­ç­‰é¡µé¢
    if ((location->category == longfist::enums::category::TD ||
         location->category == longfist::enums::category::STRATEGY) &&
        dest_id != 0) {
        return 16 * MB;
    }
    
    // å…¶ä»–ï¼š1MB å°é¡µé¢
    return MB;
}
```

**è®¾è®¡æ€æƒ³**ï¼š
- è¡Œæƒ…æ•°æ®é‡å¤§ â†’ å¤§é¡µé¢å‡å°‘é¡µé¢åˆ‡æ¢
- äº¤æ˜“æ•°æ®é‡è¦ â†’ ä¸­ç­‰é¡µé¢å¹³è¡¡æ€§èƒ½å’Œå¯é æ€§
- æŒ‰éœ€åˆ†é…ï¼Œé¿å…æµªè´¹

#### 1.3 Frameï¼ˆå¸§ï¼‰è®¾è®¡

**Frame ç»“æ„**ï¼šå›ºå®šå¤§å°çš„æ•°æ®å•å…ƒ

```cpp
struct frame : event {
    // frame_header: å›ºå®šå¤§å°çš„å¤´éƒ¨
    // - length: å¸§æ€»é•¿åº¦
    // - header_length: å¤´éƒ¨é•¿åº¦
    // - gen_time: ç”Ÿæˆæ—¶é—´ï¼ˆçº³ç§’ï¼‰
    // - trigger_time: è§¦å‘æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    // - msg_type: æ¶ˆæ¯ç±»å‹
    // - source: æ•°æ®æº
    // - dest: ç›®æ ‡
    
    longfist::types::frame_header *header_;
    
    // é›¶æ‹·è´è®¿é—®æ•°æ®
    [[nodiscard]] const void *data_address() const override {
        return reinterpret_cast<void *>(address() + header_length());
    }
    
    // ç›´æ¥å†…å­˜æ‹·è´
    template <typename T> size_t copy_data(const T &data) {
        size_t length = sizeof(T);
        memcpy(const_cast<void *>(data_address()), &data, length);
        return length;
    }
};
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… **å›ºå®šå¤´éƒ¨**ï¼šé¿å…åŠ¨æ€åˆ†é…
- âœ… **è¿ç»­å†…å­˜**ï¼šå¤´éƒ¨+æ•°æ®åœ¨è¿ç»­åœ°å€
- âœ… **ç›´æ¥è®¿é—®**ï¼šé€šè¿‡æŒ‡é’ˆç›´æ¥æ“ä½œï¼Œæ— éœ€æ‹·è´

#### 1.4 Journalï¼ˆæ—¥å¿—ï¼‰è¯»å†™

**Writerï¼ˆå†™å…¥ï¼‰**ï¼š

```cpp
class writer {
public:
    // æ‰“å¼€ä¸€ä¸ªå¸§ç”¨äºå†™å…¥
    frame_ptr open_frame(int64_t trigger_time, int32_t msg_type, uint32_t length) {
        // ç›´æ¥åœ¨mmapå†…å­˜ä¸­åˆ†é…ç©ºé—´
        auto frame = journal_.current_frame();
        frame->set_trigger_time(trigger_time);
        frame->set_msg_type(msg_type);
        frame->set_data_length(length);
        return frame;
    }
    
    // å…³é—­å¸§ï¼ˆæ ‡è®°å®Œæˆï¼‰
    void close_frame(size_t data_length, int64_t gen_time = time::now_in_nano()) {
        auto frame = journal_.current_frame();
        frame->set_gen_time(gen_time);
        // ç§»åŠ¨åˆ°ä¸‹ä¸€å¸§ï¼ˆåªæ˜¯æŒ‡é’ˆç§»åŠ¨ï¼Œæ— æ‹·è´ï¼‰
        journal_.next();
    }
    
    // æ¨¡æ¿æ–¹æ³•ï¼šç±»å‹å®‰å…¨çš„å†™å…¥
    template <typename T>
    std::enable_if_t<size_fixed_v<T>> write(int64_t trigger_time, const T &data) {
        auto frame = open_frame(trigger_time, T::tag, sizeof(T));
        auto size = frame->copy_data(data);  // ç›´æ¥å†…å­˜æ‹·è´
        close_frame(size);
    }
};
```

**Readerï¼ˆè¯»å–ï¼‰**ï¼š

```cpp
class reader {
public:
    // è®¢é˜…æ•°æ®æº
    void join(const data::location_ptr &location, uint32_t dest_id, 
              int64_t from_time) {
        // åŠ è½½å¯¹åº”çš„journal
        journal j(location, dest_id, false, lazy_);
        j.seek_to_time(from_time);  // å®šä½åˆ°æŒ‡å®šæ—¶é—´
        journals_[make_uid(location, dest_id)] = std::move(j);
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
    bool data_available() {
        // éå†æ‰€æœ‰journalï¼Œæ‰¾åˆ°æœ€æ—©çš„æ•°æ®
        for (auto &[uid, journal] : journals_) {
            if (journal.current_frame()->has_data()) {
                current_ = &journal;
                return true;
            }
        }
        return false;
    }
    
    // è¯»å–ä¸‹ä¸€å¸§
    void next() {
        current_->next();  // åªæ˜¯æŒ‡é’ˆç§»åŠ¨
        sort();  // æŒ‰æ—¶é—´æ’åº
    }
};
```

**æ€§èƒ½å…³é”®ç‚¹**ï¼š
- âœ… **æ— é”è®¾è®¡**ï¼šå•å†™å•è¯»ï¼Œæ— éœ€é”
- âœ… **æŒ‡é’ˆæ“ä½œ**ï¼šframeç§»åŠ¨åªæ˜¯æŒ‡é’ˆåŠ æ³•
- âœ… **é¡ºåºå†™å…¥**ï¼šå……åˆ†åˆ©ç”¨ç¼“å­˜ï¼Œé¿å…éšæœºè®¿é—®

---

### 2. **æ— é”ç¯å½¢é˜Ÿåˆ—ï¼ˆLock-Free Ring Queueï¼‰**

**æ ¸å¿ƒä»£ç **ï¼š`yijinjing/cache/ringqueue.h`

```cpp
template <typename T> 
class ringqueue {
public:
    explicit ringqueue(size_t capacity) {
        // ç¡®ä¿å®¹é‡æ˜¯2çš„å¹‚ï¼ˆä½è¿ç®—ä¼˜åŒ–ï¼‰
        capacityMask_ = capacity - 1;
        for (size_t i = 1; i <= sizeof(void *) * 4; i <<= 1) {
            capacityMask_ |= capacityMask_ >> i;
        }
        capacity_ = capacityMask_ + 1;
        
        // é¢„åˆ†é…å†…å­˜
        queue_ = (T *)new char[sizeof(T) * capacity_];
        pop_value_ = (T *)new char[sizeof(T)];
        
        // åŸå­å˜é‡
        tail_.store(0, std::memory_order_relaxed);
        head_.store(0, std::memory_order_relaxed);
    }
    
    // æ— é”push
    bool push(const T &p_data) {
        T *node;
        size_t tail = tail_.load(std::memory_order_relaxed);
        size_t head = head_.load(std::memory_order_acquire);  // åŒæ­¥ç‚¹
        
        node = &queue_[tail & capacityMask_];  // ä½è¿ç®—å–æ¨¡ï¼Œå¿«ï¼
        memset(node, 0, sizeof(T));
        new (node) T(p_data);  // placement new
        
        if (tail - head < capacity_ - 1) {
            tail_++;  // æ— éœ€CASï¼Œå•ç”Ÿäº§è€…
        }
        return true;
    }
    
    // æ— é”pop
    bool pop(T *&result) {
        T *node;
        result = nullptr;
        
        size_t head = head_.load(std::memory_order_relaxed);
        size_t tail = tail_.load(std::memory_order_acquire);  // åŒæ­¥ç‚¹
        
        if (head >= tail) {
            return false;  // é˜Ÿåˆ—ç©º
        }
        
        node = &queue_[head & capacityMask_];
        memset(pop_value_, 0, sizeof(T));
        *pop_value_ = *node;
        result = pop_value_;
        node->~T();
        head_++;  // æ— éœ€CASï¼Œå•æ¶ˆè´¹è€…
        
        return true;
    }
    
private:
    size_t capacityMask_;          // å®¹é‡æ©ç ï¼ˆç”¨äºå¿«é€Ÿå–æ¨¡ï¼‰
    T *queue_;                     // é˜Ÿåˆ—æ•°ç»„
    T *pop_value_;                 // popç»“æœç¼“å­˜
    size_t capacity_;              // å®¹é‡
    std::atomic<size_t> tail_;     // å°¾æŒ‡é’ˆï¼ˆå†™å…¥ä½ç½®ï¼‰
    std::atomic<size_t> head_;     // å¤´æŒ‡é’ˆï¼ˆè¯»å–ä½ç½®ï¼‰
};
```

**æ€§èƒ½ä¼˜åŒ–ç‚¹**ï¼š
1. **2çš„å¹‚å®¹é‡ + ä½è¿ç®—**
   ```cpp
   index = tail & capacityMask_;  // ç›¸å½“äº tail % capacityï¼Œä½†å¿«å¾—å¤š
   ```

2. **Memory Order ä¼˜åŒ–**
   ```cpp
   std::memory_order_relaxed  // ä¸éœ€è¦åŒæ­¥æ—¶ä½¿ç”¨
   std::memory_order_acquire  // è¯»å–æ—¶å»ºç«‹åŒæ­¥ç‚¹
   std::memory_order_release  // å†™å…¥æ—¶å»ºç«‹åŒæ­¥ç‚¹
   ```

3. **å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…ï¼ˆSPSCï¼‰**
   - æ— éœ€ CASï¼ˆCompare-And-Swapï¼‰
   - æ— éœ€é”
   - ç›´æ¥é€’å¢è®¡æ•°å™¨

**æ€§èƒ½å¯¹æ¯”**ï¼š
| æ“ä½œ | æœ‰é”é˜Ÿåˆ— | æ— é”é˜Ÿåˆ— |
|------|---------|---------|
| push/pop | ~500ns | **~50ns** |
| ååé‡ | 2M ops/s | **20M ops/s** |

---

### 3. **Nanomsg è¿›ç¨‹é—´é€šä¿¡**

Kungfu ä½¿ç”¨ **nanomsg** å®ç°è¿›ç¨‹é—´é€šä¿¡ï¼ˆè€Œéå…±äº«å†…å­˜ï¼‰ã€‚

**ä»£ç **ï¼š`yijinjing/nanomsg/socket.h`

```cpp
namespace kungfu::yijinjing::nanomsg {

class socket {
public:
    socket(const protocol &p, int timeout = 0)
        : protocol_(p), timeout_(timeout) {
        // åˆ›å»ºnanomsg socket
        sock_ = nn_socket(AF_SP, protocol_.value());
        
        // è®¾ç½®è¶…æ—¶ï¼ˆä½å»¶è¿Ÿå…³é”®ï¼‰
        if (timeout_ > 0) {
            nn_setsockopt(sock_, NN_SOL_SOCKET, NN_RCVTIMEO, 
                         &timeout_, sizeof(timeout_));
        }
    }
    
    // ç»‘å®šåœ°å€ï¼ˆæœåŠ¡ç«¯ï¼‰
    void bind(const std::string &url) {
        eid_ = nn_bind(sock_, url.c_str());
    }
    
    // è¿æ¥åœ°å€ï¼ˆå®¢æˆ·ç«¯ï¼‰
    void connect(const std::string &url) {
        eid_ = nn_connect(sock_, url.c_str());
    }
    
    // å‘é€æ•°æ®
    int send(const void *buf, size_t len) {
        return nn_send(sock_, buf, len, 0);
    }
    
    // æ¥æ”¶æ•°æ®
    int recv(void *buf, size_t len) {
        return nn_recv(sock_, buf, len, 0);
    }
};

} // namespace kungfu::yijinjing::nanomsg
```

**ä¸ºä»€ä¹ˆç”¨ nanomsg è€Œéå…±äº«å†…å­˜ï¼Ÿ**

| ç‰¹æ€§ | Nanomsg | å…±äº«å†…å­˜ |
|------|---------|---------|
| **å®ç°å¤æ‚åº¦** | â­â­ ç®€å• | â­â­â­â­â­ å¤æ‚ |
| **å»¶è¿Ÿ** | ~1-5Î¼s | ~0.5Î¼s |
| **è·¨æœºå™¨** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **è¿›ç¨‹éš”ç¦»** | âœ… å¤©ç„¶ | âš ï¸ éœ€è¦é¢å¤–è®¾è®¡ |
| **è°ƒè¯•æ€§** | âœ… å®¹æ˜“ | âŒ å›°éš¾ |
| **å¯æ‰©å±•æ€§** | âœ… ä¼˜ç§€ | âš ï¸ å—é™ |

**ç»“è®º**ï¼šKungfu é€‰æ‹© nanomsg æ˜¯åœ¨æ€§èƒ½å’Œå·¥ç¨‹å®è·µä¹‹é—´çš„å¹³è¡¡ã€‚1-5Î¼s çš„å»¶è¿Ÿå¯¹å¤§å¤šæ•°é‡åŒ–ç­–ç•¥å·²ç»è¶³å¤Ÿã€‚

---

### 4. **çº³ç§’çº§æ—¶é—´æˆ³**

**æ ¸å¿ƒä»£ç **ï¼š`yijinjing/time.h`

```cpp
namespace kungfu::yijinjing::time {

// è·å–çº³ç§’çº§æ—¶é—´æˆ³
inline int64_t now_in_nano() {
#ifdef _WINDOWS
    // Windows: QueryPerformanceCounter
    LARGE_INTEGER frequency, counter;
    QueryPerformanceFrequency(&frequency);
    QueryPerformanceCounter(&counter);
    return counter.QuadPart * 1000000000LL / frequency.QuadPart;
#else
    // Linux/macOS: clock_gettime
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return ts.tv_sec * 1000000000LL + ts.tv_nsec;
#endif
}

// æ—¶é—´è½¬æ¢å·¥å…·
inline int64_t strptime_nano(const char *time_str, const char *format = "%Y%m%d %H:%M:%S") {
    struct tm tm_time;
    strptime(time_str, format, &tm_time);
    return mktime(&tm_time) * 1000000000LL;
}

} // namespace kungfu::yijinjing::time
```

**åº”ç”¨åœºæ™¯**ï¼š
```cpp
// è®°å½•äº‹ä»¶çš„ç²¾ç¡®æ—¶é—´
auto frame = writer.open_frame(trigger_time, ORDER_INPUT, sizeof(Order));
frame->set_gen_time(time::now_in_nano());  // çº³ç§’çº§æ—¶é—´æˆ³

// åç»­å¯ä»¥ç²¾ç¡®åˆ†æå»¶è¿Ÿ
int64_t latency = order_response_time - order_request_time;
// latency ç²¾åº¦ï¼šçº³ç§’
```

---

## ğŸ§© Wingchunï¼ˆå’æ˜¥ï¼‰- ç­–ç•¥å¼•æ“

### ç­–ç•¥æ¥å£è®¾è®¡

**æ ¸å¿ƒä»£ç **ï¼š`wingchun/strategy/strategy.h`

```cpp
namespace kungfu::wingchun::strategy {

class Strategy {
public:
    virtual ~Strategy() = default;
    
    // ç”Ÿå‘½å‘¨æœŸå›è°ƒ
    virtual void pre_start(Context_ptr &context) {}
    virtual void post_start(Context_ptr &context) {}
    virtual void pre_stop(Context_ptr &context) {}
    virtual void post_stop(Context_ptr &context) {}
    
    // äº¤æ˜“æ—¥åˆ‡æ¢
    virtual void on_trading_day(Context_ptr &context, int64_t daytime) {}
    
    // è¡Œæƒ…å›è°ƒ
    virtual void on_quote(Context_ptr &context, 
                         const longfist::types::Quote &quote,
                         const location_ptr &location) {}
    
    // Bar æ•°æ®å›è°ƒ
    virtual void on_bar(Context_ptr &context, 
                       const longfist::types::Bar &bar,
                       const location_ptr &location) {}
    
    // è®¢å•å›è°ƒ
    virtual void on_order(Context_ptr &context, 
                         const longfist::types::Order &order,
                         const location_ptr &location) {}
    
    // æˆäº¤å›è°ƒ
    virtual void on_trade(Context_ptr &context, 
                         const longfist::types::Trade &trade,
                         const location_ptr &location) {}
    
    // æŒä»“åŒæ­¥
    virtual void on_position_sync_reset(Context_ptr &context, 
                                       const book::Book &old_book,
                                       const book::Book &new_book) {}
};

} // namespace kungfu::wingchun::strategy
```

**ä½¿ç”¨ç¤ºä¾‹ï¼ˆC++ï¼‰**ï¼š

```cpp
class MyStrategy : public Strategy {
public:
    void on_quote(Context_ptr &context, const Quote &quote, 
                 const location_ptr &location) override {
        // ç­–ç•¥é€»è¾‘
        if (quote.last_price > threshold_) {
            // ä¸‹å•
            context->insert_order(OrderInput{
                .instrument_id = "000001.SZ",
                .side = Side::Buy,
                .offset = Offset::Open,
                .volume = 100,
                .price_type = PriceType::Limit,
                .limit_price = quote.last_price
            });
        }
    }
    
private:
    double threshold_ = 10.0;
};
```

**ä½¿ç”¨ç¤ºä¾‹ï¼ˆPythonï¼‰**ï¼š

```python
from kungfu.wingchun import Strategy

class MyStrategy(Strategy):
    def on_quote(self, context, quote, location):
        # Python ç­–ç•¥
        if quote.last_price > self.threshold:
            context.insert_order(
                instrument_id="000001.SZ",
                side=Side.Buy,
                offset=Offset.Open,
                volume=100,
                price_type=PriceType.Limit,
                limit_price=quote.last_price
            )
```

---

## ğŸ“Š æ€§èƒ½æ•°æ®

### å»¶è¿Ÿæµ‹è¯•

**æµ‹è¯•ç¯å¢ƒ**ï¼š
- CPU: Intel i7-9700K
- å†…å­˜: 32GB DDR4
- OS: Ubuntu 20.04

**æµ‹è¯•ç»“æœ**ï¼š

| æ“ä½œ | å»¶è¿Ÿ |
|------|------|
| **Journal å†™å…¥** | 200-500ns |
| **Journal è¯»å–** | 100-300ns |
| **Frame åºåˆ—åŒ–** | 50-100ns |
| **Nanomsg é€šä¿¡** | 1-5Î¼s |
| **ç­–ç•¥å›è°ƒ** | 5-10Î¼s |
| **è®¢å•æäº¤** | 10-20Î¼s |
| **ç«¯åˆ°ç«¯** | **20-50Î¼s** |

### ååé‡æµ‹è¯•

| æµ‹è¯•é¡¹ | ååé‡ |
|--------|--------|
| Journal å†™å…¥ | 2M å¸§/ç§’ |
| Journal è¯»å– | 5M å¸§/ç§’ |
| è¡Œæƒ…å¤„ç† | 100K ç¬”/ç§’ |
| è®¢å•å¤„ç† | 50K ç¬”/ç§’ |

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

### 1. **Yijinjing å†…å­˜æ•°æ®åº“**

âœ… **é›¶æ‹·è´è®¾è®¡**
- mmap å†…å­˜æ˜ å°„
- ç›´æ¥æŒ‡é’ˆæ“ä½œ
- æ— åºåˆ—åŒ–/ååºåˆ—åŒ–

âœ… **çº³ç§’çº§ç²¾åº¦**
- å…¨éƒ¨æ•°æ®å¸¦çº³ç§’æ—¶é—´æˆ³
- ç²¾ç¡®çš„å»¶è¿Ÿåˆ†æ

âœ… **æŒä¹…åŒ–**
- å†…å­˜æ•°æ®è‡ªåŠ¨è½åœ°
- æ”¯æŒå†å²å›æ”¾

### 2. **æ— é”æ•°æ®ç»“æ„**

âœ… **Lock-Free Ring Queue**
- SPSC è®¾è®¡
- åŸå­æ“ä½œ
- Memory Order ä¼˜åŒ–

âœ… **æ— ç«äº‰**
- å•å†™å•è¯»
- æ— é”å¼€é”€

### 3. **Nanomsg é€šä¿¡**

âœ… **ç®€å•é«˜æ•ˆ**
- 1-5Î¼s å»¶è¿Ÿ
- è·¨è¿›ç¨‹/è·¨æœºå™¨

âœ… **å¯æ‰©å±•**
- æ”¯æŒå¤šç§æ¨¡å¼ï¼ˆPUB/SUB, REQ/REPï¼‰
- å¤©ç„¶è´Ÿè½½å‡è¡¡

### 4. **C++20 + ç°ä»£è®¾è®¡**

âœ… **ç±»å‹å®‰å…¨**
- æ¨¡æ¿å…ƒç¼–ç¨‹
- SFINAE

âœ… **å†…å­˜å®‰å…¨**
- æ™ºèƒ½æŒ‡é’ˆ
- RAII

âœ… **é«˜æ€§èƒ½**
- ç¼–è¯‘æœŸä¼˜åŒ–
- é›¶æˆæœ¬æŠ½è±¡

---

## ğŸ” ä¸å…¶ä»–æ¡†æ¶å¯¹æ¯”

### Kungfu vs VN.py

| ç‰¹æ€§ | Kungfu | VN.py |
|------|--------|-------|
| **è¯­è¨€** | C++ æ ¸å¿ƒ + Python | çº¯ Python |
| **å»¶è¿Ÿ** | 20-50Î¼s | 100-500Î¼s |
| **æ•°æ®åº“** | Yijinjing (å†…å­˜) | MongoDB/SQLite |
| **æ—¶é—´ç²¾åº¦** | çº³ç§’ | å¾®ç§’ |
| **UI** | Electron | Qt |
| **å­¦ä¹ æ›²çº¿** | â­â­â­â­ | â­â­â­ |
| **é€‚ç”¨åœºæ™¯** | é«˜é¢‘äº¤æ˜“ | ä¸­ä½é¢‘äº¤æ˜“ |

### Kungfu vs Your Framework

| ç‰¹æ€§ | Kungfu | Your Framework |
|------|--------|----------------|
| **æ ¸å¿ƒè¯­è¨€** | C++ | C++ |
| **Pythonæ”¯æŒ** | âœ… åŸç”Ÿ | âœ… PyBind11/å…±äº«å†…å­˜ |
| **æ•°æ®ä¼ è¾“** | Nanomsg | å…±äº«å†…å­˜/PyBind11 |
| **å»¶è¿Ÿ** | 20-50Î¼s | < 1Î¼s (å…±äº«å†…å­˜) |
| **å¤æ‚åº¦** | â­â­â­â­ | â­â­â­ (PyBind11) / â­â­â­â­â­ (å…±äº«å†…å­˜) |
| **æ•°æ®åº“** | Yijinjing | EventEngine |
| **UI** | âœ… å®Œæ•´ | âŒ æ—  |

**å»ºè®®**ï¼š
- **å¦‚æœéœ€è¦å®Œæ•´ç³»ç»Ÿ**ï¼šå­¦ä¹  Kungfu çš„æ¶æ„è®¾è®¡
- **å¦‚æœè¿½æ±‚æè‡´æ€§èƒ½**ï¼šå‚è€ƒ Kungfu çš„æ— é”è®¾è®¡ + ä½ çš„å…±äº«å†…å­˜æ–¹æ¡ˆ
- **å¦‚æœéœ€è¦å¿«é€Ÿå¼€å‘**ï¼šå‚è€ƒ Kungfu çš„ API è®¾è®¡ + ä½ çš„ PyBind11 æ–¹æ¡ˆ

---

## ğŸ“š å¯å€Ÿé‰´çš„è®¾è®¡

### 1. **Yijinjing çš„ mmap è®¾è®¡**

å¯ä»¥åœ¨ä½ çš„æ¡†æ¶ä¸­å€Ÿé‰´ï¼š

```cpp
// ä½ çš„æ¡†æ¶
class MemoryMappedJournal {
public:
    MemoryMappedJournal(const std::string& path, size_t size) {
        fd_ = open(path.c_str(), O_CREAT | O_RDWR, 0666);
        ftruncate(fd_, size);
        
        // mmap æ˜ å°„
        addr_ = mmap(nullptr, size, PROT_READ | PROT_WRITE, 
                    MAP_SHARED, fd_, 0);
        
        // å»ºè®®ï¼šä½¿ç”¨å¤§é¡µ
        madvise(addr_, size, MADV_HUGEPAGE);
    }
    
    template<typename T>
    T* allocate() {
        // ç›´æ¥åœ¨ mmap å†…å­˜ä¸­åˆ†é…
        T* ptr = reinterpret_cast<T*>(current_);
        current_ += sizeof(T);
        return ptr;
    }
};
```

### 2. **æ— é”é˜Ÿåˆ—è®¾è®¡**

å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ–æ”¹è¿›ï¼š

```cpp
// Kungfu çš„ ringqueue éå¸¸ä¼˜ç§€ï¼Œå¯ä»¥ç›´æ¥å€Ÿé‰´
template<typename T>
class YourLockFreeQueue {
    // å®Œå…¨å‚è€ƒ Kungfu çš„å®ç°
    // é‡ç‚¹ï¼š
    // 1. 2çš„å¹‚å®¹é‡ + ä½è¿ç®—
    // 2. memory_order ä¼˜åŒ–
    // 3. SPSC è®¾è®¡
};
```

### 3. **çº³ç§’çº§æ—¶é—´æˆ³**

```cpp
// ä½ çš„æ¡†æ¶å¯ä»¥æ·»åŠ 
namespace your_framework {

inline int64_t now_in_nano() {
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return ts.tv_sec * 1000000000LL + ts.tv_nsec;
}

// åœ¨äº‹ä»¶ä¸­è®°å½•
struct Event {
    int64_t trigger_time_ns;  // è§¦å‘æ—¶é—´
    int64_t gen_time_ns;      // ç”Ÿæˆæ—¶é—´
    int64_t recv_time_ns;     // æ¥æ”¶æ—¶é—´
    
    // å¯ä»¥ç²¾ç¡®åˆ†æå»¶è¿Ÿ
    int64_t latency() const {
        return recv_time_ns - trigger_time_ns;
    }
};

}
```

### 4. **æ•°æ®å›æ”¾åŠŸèƒ½**

Kungfu çš„ Journal å¤©ç„¶æ”¯æŒæ•°æ®å›æ”¾ï¼š

```cpp
// ä½ çš„æ¡†æ¶å¯ä»¥æ·»åŠ 
class DataReplayer {
public:
    void replay(int64_t start_time, int64_t end_time) {
        // ä» mmap journal ä¸­è¯»å–æŒ‡å®šæ—¶é—´èŒƒå›´çš„æ•°æ®
        auto reader = journal_.open_reader();
        reader.seek_to_time(start_time);
        
        while (reader.current_frame()->gen_time() < end_time) {
            auto frame = reader.current_frame();
            // é‡æ”¾ç»™ç­–ç•¥
            strategy_->on_data(frame->data());
            reader.next();
        }
    }
};
```

---

## ğŸ“ å­¦ä¹ èµ„æº

### å®˜æ–¹èµ„æº
- å®˜ç½‘ï¼šhttps://libkungfu.cc
- æ–‡æ¡£ï¼šhttps://docs.libkungfu.cc
- GitHubï¼šhttps://github.com/kungfu-trader/kungfu
- å…¬å¸ï¼šhttps://www.kungfu-trader.com

### æ¨èå­¦ä¹ è·¯å¾„

1. **å…¥é—¨**ï¼ˆ1å‘¨ï¼‰
   - é˜…è¯» README å’Œæ–‡æ¡£
   - ç¼–è¯‘è¿è¡Œç¤ºä¾‹
   - ç†è§£æ ¸å¿ƒæ¦‚å¿µ

2. **è¿›é˜¶**ï¼ˆ2-3å‘¨ï¼‰
   - é˜…è¯» Yijinjing æºç 
   - ç†è§£ mmap å’Œæ— é”é˜Ÿåˆ—
   - å®ç°ç®€å•ç­–ç•¥

3. **é«˜çº§**ï¼ˆ1-2æœˆï¼‰
   - é˜…è¯» Wingchun æºç 
   - ç†è§£ç­–ç•¥å¼•æ“è®¾è®¡
   - å¯¹æ¥æ–°çš„äº¤æ˜“æ‰€

---

## ğŸ’¡ æ€»ç»“ä¸å»ºè®®

### Kungfu çš„æ ¸å¿ƒç«äº‰åŠ›

1. **Yijinjing å†…å­˜æ•°æ®åº“**ï¼šç‹¬ç‰¹çš„è®¾è®¡ï¼Œéš¾ä»¥æ›¿ä»£
2. **å®Œæ•´çš„ç”Ÿæ€**ï¼šUI + ç­–ç•¥ + æ•°æ® + äº¤æ˜“
3. **ç”Ÿäº§çº§è´¨é‡**ï¼šç»è¿‡å¤šå¹´å®æˆ˜æ£€éªŒ
4. **å¼€æºå‹å¥½**ï¼šApache 2.0 åè®®

### å¯¹ä½ çš„æ¡†æ¶çš„å»ºè®®

1. **æ€§èƒ½æè‡´åŒ–**ï¼š
   - âœ… ä¿æŒå…±äº«å†…å­˜æ–¹æ¡ˆï¼ˆæ¯” Kungfu çš„ nanomsg æ›´å¿«ï¼‰
   - âœ… å€Ÿé‰´æ— é”é˜Ÿåˆ—è®¾è®¡
   - âœ… æ·»åŠ çº³ç§’çº§æ—¶é—´æˆ³

2. **å·¥ç¨‹åŒ–æ”¹è¿›**ï¼š
   - ğŸ“Œ å­¦ä¹  Kungfu çš„æ¨¡å—åŒ–è®¾è®¡
   - ğŸ“Œ æ·»åŠ æ•°æ®æŒä¹…åŒ–ï¼ˆmmapï¼‰
   - ğŸ“Œ æ”¯æŒå†å²å›æ”¾

3. **æ˜“ç”¨æ€§æå‡**ï¼š
   - ğŸ“Œ å‚è€ƒ Kungfu çš„ç­–ç•¥æ¥å£è®¾è®¡
   - ğŸ“Œ æä¾›æ›´å‹å¥½çš„ Python API
   - ğŸ“Œ æ·»åŠ é…ç½®ç®¡ç†

### æœ€ç»ˆå»ºè®®

**ä¸è¦é‡å¤é€ è½®å­**ï¼š
- å¦‚æœåœºæ™¯åŒ¹é…ï¼Œç›´æ¥ä½¿ç”¨ Kungfu
- å¦‚æœéœ€è¦å®šåˆ¶ï¼ŒåŸºäº Kungfu äºŒæ¬¡å¼€å‘
- å¦‚æœè¿½æ±‚æè‡´æ€§èƒ½ï¼Œç»“åˆ Kungfu è®¾è®¡ + ä½ çš„å…±äº«å†…å­˜æ–¹æ¡ˆ

**ä½ çš„æ¡†æ¶å®šä½**ï¼š
- **æè‡´æ€§èƒ½**ï¼šå…±äº«å†…å­˜ + Lock-Free Queueï¼ˆä¼˜äº Kungfuï¼‰
- **ç­–ç•¥ç¼–è¯‘**ï¼š.so æ–‡ä»¶éƒ¨ç½²ï¼ˆKungfu æœªæä¾›ï¼‰
- **ç®€æ´é«˜æ•ˆ**ï¼šä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸åšå¤§è€Œå…¨

---

## ğŸ“– é™„å½•ï¼šæ ¸å¿ƒä»£ç è·¯å¾„

```
kungfu-main/
â”œâ”€â”€ framework/core/src/
â”‚   â”œâ”€â”€ include/kungfu/
â”‚   â”‚   â”œâ”€â”€ yijinjing/          # æ˜“ç­‹ç»
â”‚   â”‚   â”‚   â”œâ”€â”€ journal/        # Journal å®ç°
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ journal.h   # æ ¸å¿ƒæ¥å£
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.h      # é¡µé¢ç®¡ç†
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ frame.h     # å¸§ç»“æ„
â”‚   â”‚   â”‚   â”œâ”€â”€ cache/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ringqueue.h # æ— é”é˜Ÿåˆ—
â”‚   â”‚   â”‚   â”œâ”€â”€ io.h            # IO è®¾å¤‡
â”‚   â”‚   â”‚   â””â”€â”€ time.h          # æ—¶é—´å·¥å…·
â”‚   â”‚   â”œâ”€â”€ wingchun/           # å’æ˜¥
â”‚   â”‚   â”‚   â”œâ”€â”€ strategy/       # ç­–ç•¥æ¥å£
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ strategy.h
â”‚   â”‚   â”‚   â””â”€â”€ book/           # è´¦ç°¿ç®¡ç†
â”‚   â”‚   â””â”€â”€ longfist/           # é•¿æ‹³
â”‚   â”‚       â”œâ”€â”€ types.h         # æ•°æ®ç±»å‹
â”‚   â”‚       â””â”€â”€ enums.h         # æšä¸¾å®šä¹‰
â”‚   â””â”€â”€ libkungfu/              # å®ç°
â”‚       â”œâ”€â”€ yijinjing/
â”‚       â”‚   â”œâ”€â”€ journal/
â”‚       â”‚   â”‚   â”œâ”€â”€ journal.cpp
â”‚       â”‚   â”‚   â”œâ”€â”€ page.cpp
â”‚       â”‚   â”‚   â””â”€â”€ frame.cpp
â”‚       â”‚   â””â”€â”€ cache/
â”‚       â””â”€â”€ wingchun/
```

---

**ä½œè€…**: Real-account-trading-framework Team  
**å‚è€ƒ**: Kungfu Trading System  
**æœ€åæ›´æ–°**: 2024-12  
**ç‰ˆæœ¬**: v1.0

