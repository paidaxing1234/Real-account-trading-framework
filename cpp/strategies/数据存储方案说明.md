# 行情数据存储方案

本文档介绍实盘框架中的两种行情数据存储方案：**策略端内存存储** 和 **服务端 Redis 存储**。

---

## 一、策略端内存存储（KlineManager）

### 1.1 适用场景

- 策略运行时需要快速读取最近 N 根 K 线进行计算
- 数据量小（每币种 100-200 根 K 线）
- 对延迟敏感，需要纳秒级读取速度

### 1.2 核心文件

| 文件 | 说明 |
|------|------|
| `kline_manager.py` | K线管理器，基于 NumPy 环形缓冲区 |
| `test_kline_manager.py` | 实盘测试程序 |

### 1.3 使用方法

```python
from kline_manager import KlineManager

# 初始化（保留 120 根 1s K线）
manager = KlineManager(max_bars=120, interval="1s")

# 存储 K线（收到实盘推送时调用）
manager.update("BTC-USDT", timestamp, open, high, low, close, volume)

# 读取全部 K线
data = manager.get_all("BTC-USDT")  # 返回 NumPy 结构化数组

# 读取收盘价（用于技术指标计算）
closes = manager.get_closes("BTC-USDT")  # 返回 np.ndarray

# 检查数据连续性
is_continuous, missing = manager.is_continuous("BTC-USDT")
```

### 1.4 测试程序

```bash
cd /path/to/strategies
python3 test_kline_manager.py
```

程序会：
1. 连接实盘服务器
2. 注册账户
3. 订阅 10 个币种的 1s K线
4. 每秒检查数据连续性

---

## 二、服务端 Redis 存储（DataRecorder）

### 2.1 适用场景

- 长期保存历史数据（2 小时滑动窗口）
- 多策略共享数据
- 定期从服务器拉取数据到本地备份

### 2.2 架构流程

```
OKX WebSocket
     │
     ▼
trading_server_full (C++)
     │
     ├──ZMQ──► 策略进程 (实时交易)
     │
     └──ZMQ──► data_recorder (C++)
                    │
                    ▼
              Redis (服务器)
                    │
                    │ (每1小时)
                    ▼
          redis_data_fetcher.py (本地)
                    │
                    ▼
              CSV 文件 (本地)
```

### 2.3 核心文件

| 文件 | 位置 | 说明 |
|------|------|------|
| `data_recorder.cpp` | 服务器 | C++ 数据记录器，实盘行情 → Redis |
| `redis_data_fetcher.py` | 本地 | Python 数据拉取器，Redis → CSV |

### 2.4 Redis 数据结构

| Key 格式 | 类型 | 说明 |
|----------|------|------|
| `trades:{symbol}` | List | 最近 10000 条 trades |
| `kline:{symbol}:{interval}` | Sorted Set | K线数据，score=timestamp |

数据过期时间：**2 小时**

### 2.5 服务端部署

#### 安装依赖

```bash
# Ubuntu
sudo apt install libhiredis-dev redis-server

# 启动 Redis
sudo systemctl start redis
```

#### 配置 Redis 允许外部访问

```bash
sudo vim /etc/redis/redis.conf
# 修改: bind 0.0.0.0
# 修改: protected-mode no
sudo systemctl restart redis
```

#### 编译运行

```bash
cd /path/to/cpp/build
cmake ..
make data_recorder

# 运行
./data_recorder
```

### 2.6 本地拉取数据

```bash
# 安装依赖
pip install redis

# 查看 Redis 中有哪些数据
python3 redis_data_fetcher.py --redis-host <服务器IP> --list

# 单次拉取
python3 redis_data_fetcher.py \
    --redis-host <服务器IP> \
    --symbols "BTC-USDT,ETH-USDT,SOL-USDT" \
    --intervals "1s,1m,5m,1H" \
    --output ./market_data

# 守护进程模式（每小时自动拉取）
python3 redis_data_fetcher.py \
    --redis-host <服务器IP> \
    --daemon \
    --interval-hours 1.0
```

### 2.7 本地 CSV 文件结构

```
market_data/
├── trades/
│   ├── BTC-USDT_20251219.csv
│   └── ETH-USDT_20251219.csv
└── klines/
    ├── BTC-USDT_1s_20251219.csv
    ├── BTC-USDT_1m_20251219.csv
    └── ETH-USDT_1m_20251219.csv
```

**CSV 格式：**

```csv
# trades
timestamp,symbol,price,size,side

# klines
timestamp,symbol,interval,open,high,low,close,volume
```

---

## 三、方案对比

| 特性 | KlineManager (内存) | DataRecorder (Redis) |
|------|---------------------|----------------------|
| 读取延迟 | 纳秒级 | 微秒级 |
| 数据容量 | 几百根/币种 | 几千根/币种 |
| 持久化 | 无（进程退出即丢失） | 有（Redis + CSV） |
| 适用场景 | 策略实时计算 | 历史数据备份 |
| 部署复杂度 | 低（纯 Python） | 中（需要 Redis） |

---

## 四、常见问题

### Q1: 本地无法连接服务器 Redis

检查：
1. Redis 是否监听 `0.0.0.0` 而非 `127.0.0.1`
2. 防火墙是否开放 6379 端口
3. 云服务器安全组是否允许 6379 入站

### Q2: KlineManager 数据不连续

可能原因：
1. WebSocket 断线重连
2. 网络延迟导致丢包
3. 订阅后第一根 K 线不完整

解决：等待几秒后数据会自动恢复连续。

### Q3: data_recorder 编译失败

确保安装了 hiredis：
```bash
sudo apt install libhiredis-dev  # Ubuntu
brew install hiredis              # macOS
```

