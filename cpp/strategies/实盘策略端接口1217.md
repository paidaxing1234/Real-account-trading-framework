# Sequence 策略端接口文档

> 版本: 2.1.0  
> 更新日期: 2025-12-18  
> 说明: 策略端与实盘服务器通信的完整接口文档
> 
> **v2.1.0 新增**: 多账户管理功能，支持每个策略使用独立的 OKX 账户

---

## 目录

1. [架构说明](#1-架构说明)
2. [快速开始](#2-快速开始)
3. [StrategyClient 接口](#3-strategyclient-接口)
   - [3.1 多账户管理](#31-多账户管理--新功能) ⭐ 新功能
   - [3.2 连接管理](#32-连接管理)
4. [数据结构](#4-数据结构)
5. [完整示例代码](#5-完整示例代码)
6. [常见问题](#6-常见问题)

---

## 1. 架构说明

```
OKX 交易所
     │
     │ WebSocket (行情) / REST API (下单)
     ▼
┌─────────────────────────────┐
│    实盘服务器 (C++)          │
│    trading_server_full      │
│    - trades/K线 行情        │
│    - 交易/查询 API          │
└─────────────────────────────┘
     │
     │ IPC (ZeroMQ <1ms )
     ▼
┌─────────────────────────────┐
│    策略进程 (Python)         │
│    StrategyClient           │
└─────────────────────────────┘
```

### IPC 通道

| 通道 | 地址 | 用途 |
|------|------|------|
| 行情 | `ipc:///tmp/trading_md.ipc` | trades/K线数据推送 |
| 订单 | `ipc:///tmp/trading_order.ipc` | 下单/撤单请求 |
| 回报 | `ipc:///tmp/trading_report.ipc` | 订单状态推送 |
| 查询 | `ipc:///tmp/trading_query.ipc` | 账户/持仓查询 |
| 订阅 | `ipc:///tmp/trading_sub.ipc` | 订阅管理 |

---

## 2. 快速开始

### 2.1 最简示例

```python
from strategy_client import StrategyClient

# 创建客户端
client = StrategyClient(strategy_id="my_strategy")
client.connect()

# 订阅行情
client.subscribe_trades("BTC-USDT")

# 接收行情
trade = client.recv_trade()
if trade:
    print(f"价格: {trade.price}")

# 下单 (永续合约)
order_id = client.swap_buy_limit("BTC-USDT-SWAP", quantity=1, price=50000)

# 接收回报
report = client.recv_report()
if report:
    print(f"状态: {report.status}")

client.disconnect()
```

### 2.2 使用独立账户（多账户模式）⭐

```python
from zmq_strategy_client import ZmqStrategyClient

# 创建带账户信息的客户端
client = ZmqStrategyClient(
    strategy_id="strategy_alpha",
    api_key="your-api-key",
    secret_key="your-secret-key",
    passphrase="your-passphrase",
    is_testnet=True  # 模拟盘
)
client.connect()

# 注册账户到服务器（必须在下单前调用）
client.register_account()

# 等待注册完成
import time
time.sleep(0.5)

# 现在下单将使用 strategy_alpha 的独立账户
client.send_order(
    symbol="BTC-USDT",
    side="buy",
    order_type="market",
    quantity=1
)

client.disconnect()
```

### 2.2 继承 BaseStrategy 方式(用这个)

```python
from strategy_client import BaseStrategy, TradeData, OrderReport, run_strategy

class MyStrategy(BaseStrategy):
    def __init__(self):
        super().__init__(strategy_id="my_strategy")
    
    def on_trade(self, trade: TradeData):
        """处理行情（必须实现）"""
        print(f"收到行情: {trade.symbol} @ {trade.price}")
    
    def on_report(self, report: OrderReport):
        """处理回报（可选）"""
        if report.is_filled():
            print(f"成交: {report.filled_quantity}")

if __name__ == "__main__":
    run_strategy(MyStrategy())
```

---

## 3. StrategyClient 接口

> okx官网api：https://www.okx.com/docs-v5/zh/
> 官网api参数很丰富，这边做了简化，如需扩展可以修改接口

### 3.1 多账户管理 ⭐ 新功能

多账户管理功能允许每个策略使用独立的 OKX 账户进行交易，实现策略间的资金隔离和独立风控。

#### 功能特点

- **独立账户**: 每个策略可以注册自己的 API Key，使用独立账户下单
- **自动路由**: 服务器根据 `strategy_id` 自动选择对应的 API 客户端
- **默认回退**: 未注册账户的策略自动使用服务器默认账户
- **动态管理**: 支持运行时注册/注销账户

#### 架构说明

```
策略A (strategy_A)           策略B (strategy_B)
  │ api_key_A                  │ api_key_B
  ▼                            ▼
┌────────────────────────────────────────────┐
│           Trading Server (C++)             │
│  ┌──────────────────────────────────────┐  │
│  │  多账户管理模块                        │  │
│  │  strategy_A -> OKXRestAPI(key_A)     │  │
│  │  strategy_B -> OKXRestAPI(key_B)     │  │
│  │  default    -> OKXRestAPI(default)   │  │
│  └──────────────────────────────────────┘  │
└────────────────────────────────────────────┘
        │                      │
        ▼                      ▼
   OKX 账户A               OKX 账户B
```

#### 创建带账户信息的客户端

```python
from zmq_strategy_client import ZmqStrategyClient

# 方式1：创建时传入账户信息
client = ZmqStrategyClient(
    strategy_id="my_strategy",
    api_key="25fc280c-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    secret_key="888CC77C745F1B49E75A992F38929992",
    passphrase="YourPassphrase",
    is_testnet=True  # True=模拟盘, False=实盘
)

# 连接服务器
client.connect()

# 注册账户到服务器（必须在下单前调用）
client.register_account()
```

#### register_account 方法

向实盘服务器注册策略的账户信息。

```python
def register_account(
    self,
    api_key: str = None,      # 如果不传则使用初始化时的值
    secret_key: str = None,
    passphrase: str = None,
    is_testnet: bool = None
) -> bool
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| api_key | str | 否 | OKX API Key（不传则使用初始化时的值） |
| secret_key | str | 否 | OKX Secret Key |
| passphrase | str | 否 | OKX Passphrase |
| is_testnet | bool | 否 | 是否使用模拟盘 |

**返回值**: `bool` - 发送成功返回 `True`

#### unregister_account 方法

注销策略账户，之后该策略将使用默认账户。

```python
def unregister_account(self) -> bool
```

**返回值**: `bool` - 发送成功返回 `True`

#### 账户注册回报

服务器处理账户注册后会推送回报：

```python
def on_report(self, report: dict):
    report_type = report.get("type")
    
    if report_type == "register_report":
        status = report.get("status")  # "registered" 或 "failed"
        if status == "registered":
            print("✓ 账户注册成功！")
        else:
            print(f"✗ 注册失败: {report.get('error_msg')}")
    
    elif report_type == "unregister_report":
        status = report.get("status")  # "unregistered" 或 "failed"
        if status == "unregistered":
            print("✓ 账户已注销")
```

#### 完整示例

```python
#!/usr/bin/env python3
"""多账户策略示例"""

from zmq_strategy_client import ZmqStrategyClient

def main():
    # 创建策略客户端并配置账户
    client = ZmqStrategyClient(
        strategy_id="strategy_alpha",
        api_key="your-api-key",
        secret_key="your-secret-key",
        passphrase="your-passphrase",
        is_testnet=True
    )
    
    # 连接服务器
    if not client.connect():
        print("连接失败")
        return
    
    # 注册账户
    client.register_account()
    
    # 等待注册回报
    import time
    time.sleep(0.5)
    
    # 接收注册回报
    report = client.recv_report()
    if report and report.get("type") == "register_report":
        if report.get("status") == "registered":
            print("✓ 账户注册成功，可以开始交易！")
        else:
            print(f"✗ 注册失败: {report.get('error_msg')}")
            return
    
    # 下单（将使用已注册的账户）
    client.send_order(
        symbol="BTC-USDT",
        side="buy",
        order_type="market",
        quantity=1,
        td_mode="cash"
    )
    
    # ... 策略逻辑 ...
    
    # 断开连接时自动注销账户
    client.disconnect()

if __name__ == "__main__":
    main()
```

#### 命令行参数

`zmq_strategy_client.py` 支持通过命令行指定账户信息：

```bash
python zmq_strategy_client.py \
    --strategy-id my_strategy \
    --api-key "25fc280c-xxxx-xxxx-xxxx-xxxxxxxxxxxx" \
    --secret-key "888CC77C745F1B49E75A992F38929992" \
    --passphrase "YourPassphrase" \
    --testnet  # 使用模拟盘
```

| 参数 | 说明 |
|------|------|
| `--strategy-id` | 策略唯一标识 |
| `--api-key` | OKX API Key |
| `--secret-key` | OKX Secret Key |
| `--passphrase` | OKX Passphrase |
| `--testnet` | 使用模拟盘（默认） |
| `--live` | 使用实盘 |

---

### 3.2 连接管理

```python
from strategy_client import StrategyClient

client = StrategyClient(strategy_id="my_strategy")
```

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `connect()` | 无 | bool | 连接服务器 |
| `disconnect()` | 无 | None | 断开连接（自动注销账户） |
| `register_account()` | api_key, secret_key, passphrase, is_testnet | bool | 注册策略账户 |
| `unregister_account()` | 无 | bool | 注销策略账户 |

---

### 3.2 行情订阅

#### subscribe_trades / unsubscribe_trades

订阅/取消订阅 trades（逐笔成交）数据

```python
# 订阅
client.subscribe_trades("BTC-USDT")        # 现货
client.subscribe_trades("BTC-USDT-SWAP")   # 永续合约

# 取消订阅
client.unsubscribe_trades("BTC-USDT")
```

| 参数 | 类型 | 说明 |
|------|------|------|
| symbol | str | 交易对，如 "BTC-USDT"、"BTC-USDT-SWAP" |

#### subscribe_kline / unsubscribe_kline

订阅/取消订阅 K线数据

```python
# 订阅 1分钟K线
client.subscribe_kline("BTC-USDT", "1m")

# 订阅 1小时K线
client.subscribe_kline("ETH-USDT-SWAP", "1H")

# 取消订阅
client.unsubscribe_kline("BTC-USDT", "1m")
```

| 参数 | 类型 | 说明 |
|------|------|------|
| symbol | str | 交易对 |
| interval | str | K线周期 |

**支持的K线周期：**

| 周期 | 说明 |
|------|------|
| 1s | 1秒 |
| 1m | 1分钟 |
| 3m | 3分钟 |
| 5m | 5分钟 |
| 15m | 15分钟 |
| 30m | 30分钟 |
| 1H | 1小时 |
| 2H | 2小时 |
| 4H | 4小时 |
| 6H | 6小时 |
| 12H | 12小时 |
| 1D | 1天 |
| 1W | 1周 |
| 1M | 1月 |

---

### 3.3 行情接收

#### recv_trade

接收 trades 数据（非阻塞）

```python
trade = client.recv_trade()
if trade:
    print(f"交易对: {trade.symbol}")
    print(f"价格: {trade.price}")
    print(f"数量: {trade.quantity}")
    print(f"方向: {trade.side}")
```

| 返回值 | 类型 | 说明 |
|--------|------|------|
| trade | TradeData | None | 成交数据，无数据时返回 None |

#### recv_kline

接收 K线数据（非阻塞）

```python
kline = client.recv_kline()
if kline:
    print(f"交易对: {kline.symbol}")
    print(f"周期: {kline.interval}")
    print(f"OHLCV: {kline.open}/{kline.high}/{kline.low}/{kline.close}/{kline.volume}")
```

| 返回值 | 类型 | 说明 |
|--------|------|------|
| kline | KlineData | None | K线数据，无数据时返回 None |

#### recv_market

接收任意行情数据（非阻塞）

```python
data = client.recv_market()
if data:
    msg_type = data.get("type")  # "trade" 或 "kline"
    print(f"消息类型: {msg_type}")
```

---

### 3.4 交易接口 - 现货

#### buy_market / sell_market

现货市价买入/卖出

```python
# 市价买入 10 USDT 的 BTC
order_id = client.buy_market("BTC-USDT", quantity=10)

# 市价卖出 0.001 BTC
order_id = client.sell_market("BTC-USDT", quantity=0.001)
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 交易对 |
| quantity | float | ✓ | 数量（买入为USDT金额，卖出为币数量） |
| tgt_ccy | str | × | 目标货币（默认 buy=quote_ccy, sell=base_ccy） |

#### buy_limit / sell_limit

现货限价买入/卖出

```python
# 限价买入 0.001 BTC，价格 50000
order_id = client.buy_limit("BTC-USDT", quantity=0.001, price=50000)

# 限价卖出 0.001 BTC，价格 100000
order_id = client.sell_limit("BTC-USDT", quantity=0.001, price=100000)
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 交易对 |
| quantity | float | ✓ | 数量（币数量） |
| price | float | ✓ | 价格 |

---

### 3.5 交易接口 - 永续合约

#### swap_buy_market / swap_sell_market

合约市价开多/开空

```python
# 市价开多 1 张 BTC 永续合约
order_id = client.swap_buy_market("BTC-USDT-SWAP", quantity=1)

# 市价开空 1 张
order_id = client.swap_sell_market("BTC-USDT-SWAP", quantity=1)

# 双向持仓模式需指定 pos_side
order_id = client.swap_buy_market("BTC-USDT-SWAP", quantity=1, pos_side="long")
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 合约交易对，如 "BTC-USDT-SWAP" |
| quantity | float | ✓ | 张数 |
| pos_side | str | × | 持仓方向（双向持仓模式需要）: "long"/"short" |

#### swap_buy_limit / swap_sell_limit

合约限价开多/开空

```python
# 限价开多 1 张，价格 50000
order_id = client.swap_buy_limit("BTC-USDT-SWAP", quantity=1, price=50000)

# 限价开空 1 张，价格 100000
order_id = client.swap_sell_limit("BTC-USDT-SWAP", quantity=1, price=100000)
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 合约交易对 |
| quantity | float | ✓ | 张数 |
| price | float | ✓ | 价格 |
| pos_side | str | × | 持仓方向 |

---

### 3.6 批量下单

#### batch_orders

批量下单（最多20个订单）

```python
from strategy_client import OrderRequest

orders = [
    OrderRequest(
        symbol="BTC-USDT-SWAP",
        side="buy",
        order_type="limit",
        quantity=1,
        price=50000,
        td_mode="cross"
    ),
    OrderRequest(
        symbol="BTC-USDT-SWAP",
        side="sell",
        order_type="limit",
        quantity=1,
        price=100000,
        td_mode="cross"
    )
]

batch_id = client.batch_orders(orders)
print(f"批量ID: {batch_id}")
```

**OrderRequest 参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 交易对 |
| side | str | ✓ | 方向: "buy"/"sell" |
| order_type | str | × | 类型: "market"/"limit" (默认 limit) |
| quantity | float | ✓ | 数量 |
| price | float | × | 价格（限价单必填） |
| td_mode | str | × | 交易模式: "cash"/"cross"/"isolated" |
| pos_side | str | × | 持仓方向: "long"/"short" |
| client_order_id | str | × | 客户自定义订单ID |

---

### 3.7 撤单接口

#### cancel_order

撤销单个订单

```python
# 使用交易所订单ID撤单
client.cancel_order("BTC-USDT-SWAP", order_id="12345678")

# 使用客户端订单ID撤单
client.cancel_order("BTC-USDT-SWAP", client_order_id="my_order_123")
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 交易对 |
| order_id | str | × | 交易所订单ID（二选一） |
| client_order_id | str | × | 客户端订单ID（二选一） |

#### batch_cancel

批量撤单

```python
order_ids = ["123456", "789012", "345678"]
request_id = client.batch_cancel("BTC-USDT-SWAP", order_ids)
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 交易对 |
| order_ids | List[str] | ✓ | 订单ID列表（最多20个） |

---

### 3.8 修改订单

#### amend_order

修改未成交订单的价格或数量

```python
# 修改价格
request_id = client.amend_order(
    symbol="BTC-USDT-SWAP",
    order_id="12345678",
    new_price=51000
)

# 修改数量
request_id = client.amend_order(
    symbol="BTC-USDT-SWAP",
    client_order_id="my_order_123",
    new_quantity=2
)

# 同时修改价格和数量
request_id = client.amend_order(
    symbol="BTC-USDT-SWAP",
    order_id="12345678",
    new_price=51000,
    new_quantity=2
)
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 交易对 |
| order_id | str | × | 交易所订单ID（二选一） |
| client_order_id | str | × | 客户端订单ID（二选一） |
| new_price | float | × | 新价格 |
| new_quantity | float | × | 新数量 |

---

### 3.9 查询接口

#### query_account

查询账户余额

```python
# 查询所有币种余额
result = client.query_account()

# 查询指定币种
result = client.query_account(currency="USDT")

if result and result.get("code") == 0:
    data = result["data"]
    print(f"账户数据: {data}")
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| currency | str | × | 币种（空=全部） |

#### query_positions

查询持仓信息

```python
# 查询所有合约持仓
result = client.query_positions(inst_type="SWAP")

# 查询指定交易对
result = client.query_positions(inst_type="SWAP", symbol="BTC-USDT-SWAP")

if result and result.get("code") == 0:
    for pos in result["data"]["data"]:
        print(f"持仓: {pos['instId']} | 数量: {pos['pos']} | 盈亏: {pos['upl']}")
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| inst_type | str | × | 产品类型: "SWAP"/"FUTURES"/"MARGIN" (默认 SWAP) |
| symbol | str | × | 交易对（空=全部） |

#### query_pending_orders

查询未成交订单

```python
# 查询所有未成交订单
result = client.query_pending_orders(inst_type="SWAP")

# 查询指定交易对
result = client.query_pending_orders(inst_type="SWAP", symbol="BTC-USDT-SWAP")

if result and result.get("code") == 0:
    for order in result["data"]["data"]:
        print(f"订单: {order['ordId']} | 状态: {order['state']}")
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| inst_type | str | × | 产品类型: "SPOT"/"SWAP" (默认 SPOT) |
| symbol | str | × | 交易对（空=全部） |

#### query_order

查询单个订单

```python
result = client.query_order(
    symbol="BTC-USDT-SWAP",
    order_id="12345678"
)
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | str | ✓ | 交易对 |
| order_id | str | × | 交易所订单ID（二选一） |
| client_order_id | str | × | 客户端订单ID（二选一） |

---

### 3.10 回报接收

#### recv_report

接收订单回报（非阻塞）

```python
report = client.recv_report()
if report:
    print(f"类型: {report.type}")          # order_report/batch_report/cancel_report 等
    print(f"状态: {report.status}")
    print(f"订单ID: {report.exchange_order_id}")
    
    if report.is_filled():
        print(f"成交价: {report.filled_price}")
        print(f"成交量: {report.filled_quantity}")
    
    if report.is_rejected():
        print(f"错误: {report.error_msg}")
```

**回报类型 (type)：**

| 类型 | 说明 |
|------|------|
| order_report | 单个订单回报 |
| batch_report | 批量下单回报 |
| cancel_report | 撤单回报 |
| batch_cancel_report | 批量撤单回报 |
| amend_report | 修改订单回报 |
| order_update | WebSocket订单状态推送 |
| register_report | 账户注册回报 ⭐ |
| unregister_report | 账户注销回报 ⭐ |

**订单状态 (status)：**

| 状态 | 说明 |
|------|------|
| accepted | 已接受 |
| filled | 完全成交 |
| partial | 部分成交 |
| cancelled | 已撤销 |
| rejected | 被拒绝 |
| amended | 已修改 |
| registered | 账户已注册 ⭐ |
| unregistered | 账户已注销 ⭐ |

---

## 4. 数据结构

### 4.1 TradeData

成交数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | str | 交易对 |
| trade_id | str | 成交ID |
| price | float | 成交价格 |
| quantity | float | 成交数量 |
| side | str | 方向: "buy"/"sell" |
| timestamp | int | 时间戳（毫秒） |
| timestamp_ns | int | 时间戳（纳秒） |

### 4.2 KlineData

K线数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | str | 交易对 |
| interval | str | K线周期 |
| open | float | 开盘价 |
| high | float | 最高价 |
| low | float | 最低价 |
| close | float | 收盘价 |
| volume | float | 成交量 |
| timestamp | int | 时间戳（毫秒） |

### 4.3 OrderReport

订单回报结构

| 字段 | 类型 | 说明 |
|------|------|------|
| type | str | 回报类型 |
| strategy_id | str | 策略ID |
| client_order_id | str | 客户端订单ID |
| exchange_order_id | str | 交易所订单ID |
| symbol | str | 交易对 |
| status | str | 订单状态 |
| filled_price | float | 成交价格 |
| filled_quantity | float | 成交数量 |
| fee | float | 手续费 |
| error_msg | str | 错误信息 |
| timestamp | int | 时间戳 |
| batch_id | str | 批量ID（批量订单） |
| results | List[dict] | 批量结果（批量订单） |
| success_count | int | 成功数量（批量订单） |
| fail_count | int | 失败数量（批量订单） |

**便捷方法：**

| 方法 | 返回值 | 说明 |
|------|--------|------|
| is_success() | bool | 是否成功 |
| is_filled() | bool | 是否完全成交 |
| is_rejected() | bool | 是否被拒绝 |

---

## 5. 完整示例代码

### 5.1 调用所有API的完整示例

```python
#!/usr/bin/env python3
"""
Sequence 策略端接口完整示例
演示所有可用的API调用
"""

import time
from strategy_client import (
    StrategyClient, OrderRequest, TradeData, KlineData, OrderReport
)

def main():
    # ========================================
    # 1. 创建客户端并连接
    # ========================================
    print("=" * 50)
    print("1. 创建客户端")
    print("=" * 50)
    
    client = StrategyClient(strategy_id="demo_strategy")
    
    if not client.connect():
        print("连接失败，请确保服务器已启动")
        return
    
    print("✓ 连接成功")
    
    try:
        # ========================================
        # 2. 行情订阅
        # ========================================
        print("\n" + "=" * 50)
        print("2. 行情订阅")
        print("=" * 50)
        
        # 订阅 trades
        client.subscribe_trades("BTC-USDT")
        print("✓ 订阅 trades: BTC-USDT")
        
        client.subscribe_trades("BTC-USDT-SWAP")
        print("✓ 订阅 trades: BTC-USDT-SWAP")
        
        # 订阅 K线
        client.subscribe_kline("BTC-USDT", "1m")
        print("✓ 订阅 K线: BTC-USDT 1m")
        
        client.subscribe_kline("BTC-USDT-SWAP", "1H")
        print("✓ 订阅 K线: BTC-USDT-SWAP 1H")
        
        time.sleep(1)
        
        # ========================================
        # 3. 接收行情数据
        # ========================================
        print("\n" + "=" * 50)
        print("3. 接收行情数据 (等待3秒)")
        print("=" * 50)
        
        start = time.time()
        trade_count = 0
        kline_count = 0
        
        while time.time() - start < 3:
            # 接收 trades
            trade = client.recv_trade()
            if trade:
                trade_count += 1
                if trade_count <= 3:  # 只打印前3条
                    print(f"  [Trade] {trade.symbol} | {trade.side} | "
                          f"价格: {trade.price} | 数量: {trade.quantity}")
            
            # 接收 K线
            kline = client.recv_kline()
            if kline:
                kline_count += 1
                if kline_count <= 3:
                    print(f"  [Kline] {kline.symbol} {kline.interval} | "
                          f"O:{kline.open} H:{kline.high} L:{kline.low} C:{kline.close}")
            
            time.sleep(0.01)
        
        print(f"✓ 收到 {trade_count} 条 trades, {kline_count} 条 K线")
        
        # ========================================
        # 4. 查询接口
        # ========================================
        print("\n" + "=" * 50)
        print("4. 查询接口")
        print("=" * 50)
        
        # 查询账户余额
        result = client.query_account()
        if result and result.get("code") == 0:
            print("✓ 查询账户余额成功")
            # 打印 USDT 余额
            if "data" in result and "data" in result["data"]:
                details = result["data"]["data"][0].get("details", [])
                for d in details:
                    if d.get("ccy") == "USDT":
                        print(f"  USDT 余额: {d.get('cashBal', 'N/A')}")
                        break
        else:
            print(f"✗ 查询账户失败: {result}")
        
        # 查询持仓
        result = client.query_positions(inst_type="SWAP")
        if result and result.get("code") == 0:
            print("✓ 查询持仓成功")
            if "data" in result and "data" in result["data"]:
                positions = result["data"]["data"]
                if positions:
                    for pos in positions[:3]:  # 只打印前3个
                        print(f"  持仓: {pos.get('instId')} | "
                              f"数量: {pos.get('pos')} | 方向: {pos.get('posSide')}")
                else:
                    print("  (无持仓)")
        
        # 查询未成交订单
        result = client.query_pending_orders(inst_type="SWAP")
        if result and result.get("code") == 0:
            print("✓ 查询未成交订单成功")
            if "data" in result and "data" in result["data"]:
                orders = result["data"]["data"]
                print(f"  未成交订单数: {len(orders)}")
        
        # ========================================
        # 5. 交易接口 - 单个下单
        # ========================================
        print("\n" + "=" * 50)
        print("5. 交易接口 - 单个下单")
        print("=" * 50)
        
        # 永续合约限价下单
        order_id = client.swap_buy_limit(
            symbol="BTC-USDT-SWAP",
            quantity=1,
            price=50000  # 设置一个较低的价格，不会成交
        )
        print(f"✓ 永续合约限价开多: {order_id}")
        
        # 等待回报
        time.sleep(1)
        report = client.recv_report()
        if report:
            print(f"  回报: {report.status} | 交易所ID: {report.exchange_order_id}")
            saved_order_id = report.exchange_order_id
        else:
            print("  (未收到回报)")
            saved_order_id = ""
        
        # ========================================
        # 6. 交易接口 - 批量下单
        # ========================================
        print("\n" + "=" * 50)
        print("6. 交易接口 - 批量下单")
        print("=" * 50)
        
        orders = [
            OrderRequest(
                symbol="BTC-USDT-SWAP",
                side="buy",
                order_type="limit",
                quantity=1,
                price=48000,
                td_mode="cross"
            ),
            OrderRequest(
                symbol="BTC-USDT-SWAP",
                side="sell",
                order_type="limit",
                quantity=1,
                price=150000,
                td_mode="cross"
            )
        ]
        
        batch_id = client.batch_orders(orders)
        print(f"✓ 批量下单: {batch_id}")
        
        # 等待批量回报
        time.sleep(1)
        report = client.recv_report()
        if report and report.type == "batch_report":
            print(f"  批量结果: 成功={report.success_count} 失败={report.fail_count}")
            batch_order_ids = []
            for r in report.results:
                print(f"    - {r.get('client_order_id')}: {r.get('status')}")
                if r.get("exchange_order_id"):
                    batch_order_ids.append(r.get("exchange_order_id"))
        else:
            batch_order_ids = []
        
        # ========================================
        # 7. 修改订单
        # ========================================
        print("\n" + "=" * 50)
        print("7. 修改订单")
        print("=" * 50)
        
        if saved_order_id:
            request_id = client.amend_order(
                symbol="BTC-USDT-SWAP",
                order_id=saved_order_id,
                new_price=49000
            )
            print(f"✓ 修改订单请求: {request_id}")
            
            time.sleep(1)
            report = client.recv_report()
            if report:
                print(f"  修改结果: {report.status}")
        else:
            print("  (跳过，无有效订单)")
        
        # ========================================
        # 8. 撤单
        # ========================================
        print("\n" + "=" * 50)
        print("8. 撤单接口")
        print("=" * 50)
        
        # 撤销单个订单
        if saved_order_id:
            request_id = client.cancel_order("BTC-USDT-SWAP", order_id=saved_order_id)
            print(f"✓ 撤销单个订单: {request_id}")
            
            time.sleep(1)
            report = client.recv_report()
            if report:
                print(f"  撤单结果: {report.status}")
        
        # 批量撤单
        if batch_order_ids:
            request_id = client.batch_cancel("BTC-USDT-SWAP", batch_order_ids)
            print(f"✓ 批量撤单: {request_id}")
            
            time.sleep(1)
            report = client.recv_report()
            if report:
                print(f"  批量撤单结果: 成功={report.success_count} 失败={report.fail_count}")
        
        # ========================================
        # 9. 取消订阅
        # ========================================
        print("\n" + "=" * 50)
        print("9. 取消订阅")
        print("=" * 50)
        
        client.unsubscribe_trades("BTC-USDT")
        print("✓ 取消订阅 trades: BTC-USDT")
        
        client.unsubscribe_kline("BTC-USDT", "1m")
        print("✓ 取消订阅 K线: BTC-USDT 1m")
        
    except KeyboardInterrupt:
        print("\n用户中断")
    
    finally:
        # ========================================
        # 10. 断开连接
        # ========================================
        print("\n" + "=" * 50)
        print("10. 断开连接")
        print("=" * 50)
        
        client.disconnect()
        print("✓ 已断开连接")
        
        # 打印统计
        print(f"\n统计: trades={client.trade_count} klines={client.kline_count} "
              f"orders={client.order_count} reports={client.report_count}")


if __name__ == "__main__":
    main()
```

### 5.2 简单策略示例

```python
#!/usr/bin/env python3
"""
简单均线策略示例
"""

from collections import deque
from strategy_client import BaseStrategy, TradeData, OrderReport, run_strategy

class SimpleMAStrategy(BaseStrategy):
    """简单移动平均策略"""
    
    def __init__(self):
        super().__init__(strategy_id="ma_strategy")
        
        # 参数
        self.symbol = "BTC-USDT-SWAP"
        self.short_period = 10
        self.long_period = 30
        self.trade_size = 1  # 张数
        
        # 状态
        self.prices = deque(maxlen=self.long_period)
        self.position = 0
        self.last_signal = None
    
    def on_init(self):
        # 订阅行情
        self.client.subscribe_trades(self.symbol)
    
    def on_start(self):
        self.log(f"策略启动 | 短期: {self.short_period} | 长期: {self.long_period}")
    
    def on_trade(self, trade: TradeData):
        # 只处理目标交易对
        if trade.symbol != self.symbol:
            return
        
        self.prices.append(trade.price)
        
        if len(self.prices) < self.long_period:
            return
        
        # 计算均线
        short_ma = sum(list(self.prices)[-self.short_period:]) / self.short_period
        long_ma = sum(self.prices) / self.long_period
        
        # 生成信号
        signal = "buy" if short_ma > long_ma else "sell"
        
        # 执行交易
        if signal != self.last_signal:
            self.last_signal = signal
            
            if signal == "buy" and self.position <= 0:
                self.swap_buy(self.symbol, self.trade_size)
                self.log(f"开多 | 短MA={short_ma:.2f} > 长MA={long_ma:.2f}")
            
            elif signal == "sell" and self.position > 0:
                self.swap_sell(self.symbol, abs(self.position))
                self.log(f"平多 | 短MA={short_ma:.2f} < 长MA={long_ma:.2f}")
    
    def on_report(self, report: OrderReport):
        if report.is_filled():
            # 更新持仓（简化处理）
            if "buy" in str(report.client_order_id):
                self.position += report.filled_quantity
            else:
                self.position -= report.filled_quantity
            
            self.log(f"成交 | 价格: {report.filled_price} | 持仓: {self.position}")


if __name__ == "__main__":
    run_strategy(SimpleMAStrategy())
```

## 附录: API 速览表

### 行情订阅
| 方法 | 说明 |
|------|------|
| `subscribe_trades(symbol)` | 订阅 trades |
| `unsubscribe_trades(symbol)` | 取消订阅 trades |
| `subscribe_kline(symbol, interval)` | 订阅 K线 |
| `unsubscribe_kline(symbol, interval)` | 取消订阅 K线 |

### 行情接收
| 方法 | 说明 |
|------|------|
| `recv_trade()` | 接收 trades |
| `recv_kline()` | 接收 K线 |
| `recv_market()` | 接收任意行情 |

### 交易（现货）
| 方法 | 说明 |
|------|------|
| `buy_market(symbol, quantity)` | 市价买入 |
| `sell_market(symbol, quantity)` | 市价卖出 |
| `buy_limit(symbol, quantity, price)` | 限价买入 |
| `sell_limit(symbol, quantity, price)` | 限价卖出 |

### 交易（合约）
| 方法 | 说明 |
|------|------|
| `swap_buy_market(symbol, quantity)` | 市价开多 |
| `swap_sell_market(symbol, quantity)` | 市价开空 |
| `swap_buy_limit(symbol, quantity, price)` | 限价开多 |
| `swap_sell_limit(symbol, quantity, price)` | 限价开空 |

### 批量操作
| 方法 | 说明 |
|------|------|
| `batch_orders(orders)` | 批量下单 |
| `batch_cancel(symbol, order_ids)` | 批量撤单 |

### 订单管理
| 方法 | 说明 |
|------|------|
| `cancel_order(symbol, order_id)` | 撤销订单 |
| `amend_order(symbol, order_id, new_price, new_quantity)` | 修改订单 |

### 查询
| 方法 | 说明 |
|------|------|
| `query_account(currency)` | 查询账户余额 |
| `query_positions(inst_type, symbol)` | 查询持仓 |
| `query_pending_orders(inst_type, symbol)` | 查询未成交订单 |
| `query_order(symbol, order_id)` | 查询单个订单 |

### 回报接收
| 方法 | 说明 |
|------|------|
| `recv_report()` | 接收订单回报 |
| `recv_report_raw()` | 接收原始回报 |
