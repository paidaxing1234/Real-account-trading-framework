# ZeroMQ 实盘交易框架设计文档

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **项目名称** | Sequence 实盘交易框架 |
| **架构模式** | 多进程 + ZeroMQ IPC |
| **服务端语言** | C++ |
| **策略端语言** | Python |
| **预期延迟** | 30-100μs (IPC) |
| **创建日期** | 2024-12 |

---

## 一、架构概述

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              服务器 (靠近交易所)                              │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                     C++ Trading Server (主进程)                        │ │
│  │                                                                       │ │
│  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │ │
│  │   │  OKX WebSocket  │    │  OKX REST API   │    │   风控模块       │  │ │
│  │   │   (行情接收)     │    │   (下单/撤单)    │    │   (可选)        │  │ │
│  │   └────────┬────────┘    └────────▲────────┘    └─────────────────┘  │ │
│  │            │                      │                                   │ │
│  │            ▼                      │                                   │ │
│  │   ┌─────────────────┐    ┌───────┴─────────┐    ┌─────────────────┐  │ │
│  │   │  行情发布器      │    │   订单处理器     │    │   回报发布器     │  │ │
│  │   │  (ZMQ PUB)      │    │   (ZMQ PULL)    │    │   (ZMQ PUB)     │  │ │
│  │   │                 │    │                 │    │                 │  │ │
│  │   │ ipc://md.ipc    │    │ ipc://order.ipc │    │ ipc://report.ipc│  │ │
│  │   └────────┬────────┘    └────────▲────────┘    └────────┬────────┘  │ │
│  │            │                      │                      │           │ │
│  └────────────┼──────────────────────┼──────────────────────┼───────────┘ │
│               │                      │                      │             │
│               │    Unix Domain Socket (IPC 通道)            │             │
│               │         延迟: 30-100μs                      │             │
│               │                      │                      │             │
│  ┌────────────┼──────────────────────┼──────────────────────┼───────────┐ │
│  │            ▼                      │                      ▼           │ │
│  │   ┌─────────────────┐    ┌───────┴─────────┐    ┌─────────────────┐  │ │
│  │   │   SUB (行情)    │    │   PUSH (订单)   │    │   SUB (回报)    │  │ │
│  │   └────────┬────────┘    └────────▲────────┘    └────────┬────────┘  │ │
│  │            │                      │                      │           │ │
│  │            ▼                      │                      ▼           │ │
│  │   ┌───────────────────────────────────────────────────────────────┐  │ │
│  │   │                    Python 策略进程                             │  │ │
│  │   │                                                               │  │ │
│  │   │    on_ticker(data)  ──►  策略逻辑  ──►  send_order(order)     │  │ │
│  │   │                                                               │  │ │
│  │   │    on_order(report) ◄──  回报处理                             │  │ │
│  │   └───────────────────────────────────────────────────────────────┘  │ │
│  │                           策略1 (独立进程)                           │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                           策略2 (独立进程)                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                           策略3 (独立进程)                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计理念

| 原则 | 说明 |
|------|------|
| **进程隔离** | 每个策略独立进程，崩溃不影响其他 |
| **松耦合** | 通过消息队列通信，服务端和策略端可独立开发 |
| **低延迟** | 使用 Unix Domain Socket (IPC)，延迟 30-100μs |
| **可扩展** | 策略可随时启动/停止，无需重启服务端 |
| **语言无关** | 服务端 C++，策略端 Python，通过协议通信 |

---

## 二、通信原理

### 2.1 三种 IPC 方式对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           TCP/IP (localhost)                                │
│                                                                             │
│    应用层数据                                                               │
│         │                                                                   │
│         ▼                                                                   │
│    ┌─────────┐                                                             │
│    │TCP 协议 │ ← 分段、序列号、校验和、流控、拥塞控制                       │
│    └────┬────┘                                                             │
│         ▼                                                                   │
│    ┌─────────┐                                                             │
│    │IP 协议  │ ← 路由查找、分片、TTL                                       │
│    └────┬────┘                                                             │
│         ▼                                                                   │
│    ┌─────────┐                                                             │
│    │网络设备 │ ← loopback 队列、软中断                                     │
│    └────┬────┘                                                             │
│         │                                                                   │
│    【反向解析】                                                             │
│         │                                                                   │
│         ▼                                                                   │
│    接收进程                                                                 │
│                                                                             │
│    延迟: 100-300μs    内存拷贝: 4-6次    CPU开销: 高                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        Unix Domain Socket (IPC)                             │
│                                                                             │
│    应用层数据                                                               │
│         │                                                                   │
│         ▼                                                                   │
│    ┌─────────────────────────────────────┐                                 │
│    │         内核 Socket 缓冲区           │                                 │
│    │                                     │                                 │
│    │    memcpy(kernel_buf, user_buf)    │  ← 仅一次系统调用               │
│    │              │                      │                                 │
│    │              ▼                      │                                 │
│    │    唤醒接收进程                      │                                 │
│    │                                     │                                 │
│    └─────────────────────────────────────┘                                 │
│         │                                                                   │
│         ▼                                                                   │
│    接收进程                                                                 │
│                                                                             │
│    延迟: 30-100μs    内存拷贝: 1-2次    CPU开销: 低                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           共享内存 (Shared Memory)                          │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                      共享内存区域                                │     │
│    │                                                                 │     │
│    │   进程A ──► 直接写入 ──► [数据] ──► 直接读取 ──► 进程B          │     │
│    │                                                                 │     │
│    │           没有系统调用！没有内核参与！                            │     │
│    │                                                                 │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│    延迟: 0.2-2μs    内存拷贝: 0次(零拷贝)    CPU开销: 最低                  │
│                                                                             │
│    但是：需要自己实现同步机制（原子操作、内存屏障）                          │
│          需要自己实现消息协议                                               │
│          调试困难                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 详细延迟分解

| 环节 | TCP localhost | Unix Socket | 共享内存 |
|------|--------------|-------------|----------|
| 系统调用 | ~1μs | ~1μs | ~0.1μs |
| 协议处理 | ~80μs | 0 | 0 |
| 数据拷贝 | ~40μs | ~20μs | 0 |
| 进程唤醒 | ~50μs | ~30μs | ~1μs |
| **总计** | **~170μs** | **~50μs** | **~1μs** |

### 2.3 为什么选择 ZeroMQ IPC？

```
                        开发效率 vs 性能权衡
                        
    延迟(μs)
    │
300 ┤ ████████████████████████████  TCP
    │
200 ┤
    │
100 ┤
    │
 50 ┤ ████████████  ZeroMQ IPC  ← 我们的选择（最佳平衡点）
    │
 20 ┤ ██████  原生 Unix Socket
    │
  2 ┤ ██  共享内存
    │
    └────────────────────────────────────────────
          1天    2天    3天    5天    10天
                      开发时间
```

**选择 ZeroMQ IPC 的原因**：

| 因素 | 说明 |
|------|------|
| **开发速度** | 1-2天完成，API 极简 |
| **延迟可接受** | 30-100μs，对于 OKX (200ms网络延迟) 可忽略 |
| **内置功能** | 消息边界、高水位、多种模式 |
| **跨语言** | C++ 和 Python 都有成熟库 |
| **调试简单** | 比共享内存容易很多 |

---

## 三、消息协议设计

### 3.1 消息类型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              消息类型定义                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  行情消息 (Market Data)                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ type: "ticker"                                                      │   │
│  │ symbol: "BTC-USDT"                                                  │   │
│  │ timestamp: 1702000000000  (毫秒)                                    │   │
│  │ last_price: 43250.5                                                 │   │
│  │ bid_price: 43250.0                                                  │   │
│  │ ask_price: 43251.0                                                  │   │
│  │ bid_size: 1.5                                                       │   │
│  │ ask_size: 2.0                                                       │   │
│  │ volume_24h: 15000.0                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  订单请求 (Order Request)                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ type: "order_request"                                               │   │
│  │ client_order_id: "strategy1_001"                                    │   │
│  │ strategy_id: "momentum_btc"                                         │   │
│  │ symbol: "BTC-USDT"                                                  │   │
│  │ side: "buy" | "sell"                                                │   │
│  │ order_type: "limit" | "market"                                      │   │
│  │ price: 43250.0  (限价单必填)                                         │   │
│  │ quantity: 0.01                                                      │   │
│  │ timestamp: 1702000000000                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  订单回报 (Order Report)                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ type: "order_report"                                                │   │
│  │ client_order_id: "strategy1_001"                                    │   │
│  │ exchange_order_id: "12345678"                                       │   │
│  │ strategy_id: "momentum_btc"                                         │   │
│  │ symbol: "BTC-USDT"                                                  │   │
│  │ status: "accepted" | "filled" | "cancelled" | "rejected"            │   │
│  │ filled_price: 43250.0                                               │   │
│  │ filled_quantity: 0.01                                               │   │
│  │ fee: 0.00001                                                        │   │
│  │ error_msg: ""  (失败时填写)                                          │   │
│  │ timestamp: 1702000000000                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 序列化格式

**选择 JSON**（开发阶段）：
- 可读性好，便于调试
- Python/C++ 都有成熟库
- 性能足够（序列化 < 10μs）

**可选优化**（生产阶段）：
- MessagePack：二进制 JSON，体积小 50%
- FlatBuffers：零拷贝，延迟最低

### 3.3 ZeroMQ 通道设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ZeroMQ 通道设计                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  通道1: 行情分发 (PUB-SUB)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │   Server (PUB)                    Clients (SUB)                     │   │
│  │   ┌─────────┐                     ┌─────────┐                       │   │
│  │   │ bind()  │ ──────────────────► │connect()│  策略1                │   │
│  │   │         │                     └─────────┘                       │   │
│  │   │  发布   │                     ┌─────────┐                       │   │
│  │   │  行情   │ ──────────────────► │connect()│  策略2                │   │
│  │   │         │                     └─────────┘                       │   │
│  │   │         │                     ┌─────────┐                       │   │
│  │   │         │ ──────────────────► │connect()│  策略3                │   │
│  │   └─────────┘                     └─────────┘                       │   │
│  │                                                                     │   │
│  │   地址: ipc:///tmp/trading_md.ipc                                   │   │
│  │   特点: 一对多广播，策略可随时订阅/取消                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  通道2: 订单提交 (PUSH-PULL)                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │   Clients (PUSH)                  Server (PULL)                     │   │
│  │   ┌─────────┐                     ┌─────────┐                       │   │
│  │   │ 策略1   │ ──────────────────► │         │                       │   │
│  │   └─────────┘                     │  bind() │                       │   │
│  │   ┌─────────┐                     │         │                       │   │
│  │   │ 策略2   │ ──────────────────► │ 汇聚订单│                       │   │
│  │   └─────────┘                     │         │                       │   │
│  │   ┌─────────┐                     │         │                       │   │
│  │   │ 策略3   │ ──────────────────► │         │                       │   │
│  │   └─────────┘                     └─────────┘                       │   │
│  │                                                                     │   │
│  │   地址: ipc:///tmp/trading_order.ipc                                │   │
│  │   特点: 多对一汇聚，负载均衡                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  通道3: 订单回报 (PUB-SUB)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │   Server (PUB)                    Clients (SUB)                     │   │
│  │   ┌─────────┐                     ┌─────────┐                       │   │
│  │   │         │ ──────────────────► │ 策略1   │ (过滤自己的回报)       │   │
│  │   │  广播   │                     └─────────┘                       │   │
│  │   │  回报   │                     ┌─────────┐                       │   │
│  │   │         │ ──────────────────► │ 策略2   │                       │   │
│  │   └─────────┘                     └─────────┘                       │   │
│  │                                                                     │   │
│  │   地址: ipc:///tmp/trading_report.ipc                               │   │
│  │   特点: 策略根据 strategy_id 过滤自己的回报                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、优势与劣势分析

### 4.1 优势

| 优势 | 详细说明 |
|------|---------|
| **进程隔离** | 策略崩溃不影响服务端和其他策略，系统稳定性高 |
| **灵活部署** | 策略可随时启动/停止，无需重启服务端 |
| **开发效率** | 策略用 Python 开发，迭代快；核心用 C++ 保证性能 |
| **调试方便** | 可以单独调试某个策略，不影响整体系统 |
| **资源隔离** | 每个策略独立进程，内存/CPU 可单独监控和限制 |
| **语言无关** | 通过消息协议通信，未来可支持其他语言的策略 |
| **延迟可控** | IPC 延迟 30-100μs，对于数字货币市场足够 |

### 4.2 劣势

| 劣势 | 影响程度 | 缓解方案 |
|------|---------|---------|
| **延迟比共享内存高** | 低 | 交易所延迟 200ms 是主导因素 |
| **序列化开销** | 低 | 使用高效格式（JSON/MessagePack） |
| **进程间无法共享状态** | 中 | 设计无状态策略，或引入 Redis |
| **消息可能丢失** | 低 | ZeroMQ 高水位机制 + 持久化 |
| **资源开销** | 低 | 每个策略额外 ~10MB 内存 |

### 4.3 与其他方案对比

```
                    适用场景分析
                    
    吞吐量(msg/s)
    │
 1M ┤                              ████  共享内存
    │                              ████  (高频交易)
    │                              ████
    │
500K┤
    │
    │
100K┤            ████████████████  ZeroMQ IPC
    │            ████████████████  (中频交易) ← 我们的场景
    │            ████████████████
    │
 10K┤ ████████████████████████████  TCP/gRPC
    │ ████████████████████████████  (低频/分布式)
    │
    └────────────────────────────────────────────
         简单              复杂度              复杂
```

| 方案 | 延迟 | 吞吐量 | 复杂度 | 适用场景 |
|------|------|--------|--------|----------|
| TCP/gRPC | 200-500μs | 10K/s | 低 | 分布式系统 |
| **ZeroMQ IPC** | **30-100μs** | **100K/s** | **低** | **本地多进程** ✅ |
| 共享内存 | 1-5μs | 1M/s | 高 | 极端高频 |
| PyBind11 | 10-50μs | 50K/s | 中 | 单进程嵌入 |

---

## 五、模块设计

### 5.1 C++ 服务端模块

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        C++ Trading Server 模块图                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         main.cpp                                    │   │
│  │                                                                     │   │
│  │  - 初始化各模块                                                     │   │
│  │  - 启动事件循环                                                     │   │
│  │  - 信号处理 (Ctrl+C)                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│          ┌──────────────────┼──────────────────┐                           │
│          │                  │                  │                           │
│          ▼                  ▼                  ▼                           │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                    │
│  │ MarketData   │   │ OrderManager │   │ ZmqServer    │                    │
│  │ Adapter      │   │              │   │              │                    │
│  ├──────────────┤   ├──────────────┤   ├──────────────┤                    │
│  │              │   │              │   │              │                    │
│  │ - WebSocket  │   │ - 订单队列   │   │ - PUB 行情   │                    │
│  │   连接管理   │   │ - 风控检查   │   │ - PULL 订单  │                    │
│  │ - 行情解析   │   │ - REST下单   │   │ - PUB 回报   │                    │
│  │ - 心跳维护   │   │ - 状态追踪   │   │              │                    │
│  │              │   │              │   │              │                    │
│  └──────┬───────┘   └──────┬───────┘   └──────┬───────┘                    │
│         │                  │                  │                            │
│         │                  │                  │                            │
│         ▼                  ▼                  ▼                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      adapters/okx/                                  │   │
│  │                                                                     │   │
│  │  ┌─────────────────┐    ┌─────────────────┐                        │   │
│  │  │ okx_websocket.h │    │ okx_rest_api.h  │    (已有实现)           │   │
│  │  │ okx_websocket.cpp│    │ okx_rest_api.cpp│                        │   │
│  │  └─────────────────┘    └─────────────────┘                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Python 客户端模块

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Python Strategy Client 模块图                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    trading_client/                                  │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    client.py                                │   │   │
│  │  │                                                             │   │   │
│  │  │  class TradingClient:                                       │   │   │
│  │  │      def __init__(server_addr):                             │   │   │
│  │  │          # 连接 ZeroMQ 通道                                  │   │   │
│  │  │                                                             │   │   │
│  │  │      def subscribe(symbols):                                │   │   │
│  │  │          # 订阅行情                                          │   │   │
│  │  │                                                             │   │   │
│  │  │      def send_order(order):                                 │   │   │
│  │  │          # 发送订单                                          │   │   │
│  │  │                                                             │   │   │
│  │  │      def run(strategy):                                     │   │   │
│  │  │          # 启动事件循环                                      │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    strategy.py                              │   │   │
│  │  │                                                             │   │   │
│  │  │  class Strategy(ABC):                                       │   │   │
│  │  │      @abstractmethod                                        │   │   │
│  │  │      def on_ticker(data): pass                              │   │   │
│  │  │                                                             │   │   │
│  │  │      @abstractmethod                                        │   │   │
│  │  │      def on_order(report): pass                             │   │   │
│  │  │                                                             │   │   │
│  │  │      def buy_limit(symbol, qty, price): ...                 │   │   │
│  │  │      def sell_limit(symbol, qty, price): ...                │   │   │
│  │  │      def buy_market(symbol, qty): ...                       │   │   │
│  │  │      def cancel_order(order_id): ...                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    models.py                                │   │   │
│  │  │                                                             │   │   │
│  │  │  @dataclass                                                 │   │   │
│  │  │  class TickerData:                                          │   │   │
│  │  │      symbol: str                                            │   │   │
│  │  │      last_price: float                                      │   │   │
│  │  │      ...                                                    │   │   │
│  │  │                                                             │   │   │
│  │  │  @dataclass                                                 │   │   │
│  │  │  class OrderReport:                                         │   │   │
│  │  │      client_order_id: str                                   │   │   │
│  │  │      status: str                                            │   │   │
│  │  │      ...                                                    │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 目录结构

```
Real-account-trading-framework/
├── cpp/
│   ├── server/                    # 新增：ZeroMQ 服务端
│   │   ├── main.cpp              # 入口
│   │   ├── zmq_server.h          # ZeroMQ 封装
│   │   ├── zmq_server.cpp
│   │   ├── market_publisher.h    # 行情发布
│   │   ├── market_publisher.cpp
│   │   ├── order_handler.h       # 订单处理
│   │   └── order_handler.cpp
│   │
│   ├── adapters/okx/             # 已有：OKX 适配器
│   │   ├── okx_rest_api.h
│   │   ├── okx_rest_api.cpp
│   │   ├── okx_websocket.h
│   │   └── okx_websocket.cpp
│   │
│   ├── core/                      # 已有：核心组件
│   │   ├── event.h
│   │   ├── order.h
│   │   └── ...
│   │
│   └── CMakeLists.txt
│
├── python/
│   ├── trading_client/            # 新增：Python 客户端库
│   │   ├── __init__.py
│   │   ├── client.py             # 客户端主类
│   │   ├── strategy.py           # 策略基类
│   │   └── models.py             # 数据模型
│   │
│   ├── strategies/                # 示例策略
│   │   ├── momentum_strategy.py
│   │   └── mean_revert_strategy.py
│   │
│   └── adapters/okx/              # 已有：Python OKX 适配器
│       └── ...
│
└── docs/
    └── ZeroMQ实盘框架设计文档.md  # 本文档
```

---

## 六、数据流详解

### 6.1 行情数据流

```
时间线 →
──────────────────────────────────────────────────────────────────────────►

OKX交易所        C++ Server              策略1              策略2
    │                │                    │                  │
    │   WebSocket    │                    │                  │
    │ ─────────────► │                    │                  │
    │   行情推送     │                    │                  │
    │   (50-200ms)   │                    │                  │
    │                │                    │                  │
    │                │  解析JSON          │                  │
    │                │  构建Ticker        │                  │
    │                │  (~10μs)           │                  │
    │                │                    │                  │
    │                │  ZMQ PUB           │                  │
    │                │ ─────────────────► │                  │
    │                │      (~50μs)       │                  │
    │                │ ─────────────────────────────────────►│
    │                │                    │                  │
    │                │                    │  on_ticker()     │
    │                │                    │  策略计算         │
    │                │                    │  (~1-10ms)       │
    │                │                    │                  │
    │                │                    │                  │
```

### 6.2 订单数据流

```
时间线 →
──────────────────────────────────────────────────────────────────────────►

策略1           C++ Server              OKX交易所           策略1
   │                │                       │                  │
   │  send_order()  │                       │                  │
   │  ZMQ PUSH      │                       │                  │
   │ ─────────────► │                       │                  │
   │    (~50μs)     │                       │                  │
   │                │                       │                  │
   │                │   REST API            │                  │
   │                │ ────────────────────► │                  │
   │                │      (200-500ms)      │                  │
   │                │                       │                  │
   │                │   订单确认            │                  │
   │                │ ◄──────────────────── │                  │
   │                │                       │                  │
   │                │   ZMQ PUB 回报        │                  │
   │                │ ─────────────────────────────────────► │
   │                │       (~50μs)         │                  │
   │                │                       │   on_order()     │
   │                │                       │   处理回报       │
   │                │                       │                  │
```

---

## 七、开发计划

### 7.1 阶段划分

| 阶段 | 任务 | 预计时间 |
|------|------|---------|
| **Phase 1** | C++ ZeroMQ 服务端框架 | 1天 |
| **Phase 2** | Python 客户端库 | 0.5天 |
| **Phase 3** | 集成 OKX 适配器 | 0.5天 |
| **Phase 4** | 示例策略 + 测试 | 0.5天 |
| **总计** | | **2.5天** |

### 7.2 依赖安装

**C++ 依赖**：
```bash
# Ubuntu/Debian
sudo apt-get install libzmq3-dev

# macOS
brew install zeromq
```

**Python 依赖**：
```bash
pip install pyzmq
```

---

## 八、总结

### 8.1 方案选择理由

| 需求 | ZeroMQ IPC 满足程度 |
|------|-------------------|
| 快速开发 | ✅ 1-2天完成 |
| 策略随时启停 | ✅ 独立进程 |
| 系统稳定性 | ✅ 进程隔离 |
| 延迟要求 | ✅ 30-100μs |
| Python策略 | ✅ pyzmq 成熟 |
| C++服务端 | ✅ libzmq 成熟 |

### 8.2 未来扩展

1. **性能优化**：
   - 序列化改用 MessagePack/FlatBuffers
   - 添加消息压缩

2. **功能扩展**：
   - 支持更多交易所
   - 添加风控模块
   - 添加持久化日志

3. **分布式部署**（如需要）：
   - IPC 改为 TCP
   - 添加服务发现

---

**文档版本**: v1.0  
**作者**: Sequence Team  
**最后更新**: 2024-12

